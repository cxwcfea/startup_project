"use strict";angular.module("mobileApp",["ngResource","ngRoute","commonApp"]),angular.module("mobileApp").config(["$routeProvider","$httpProvider",function(a,b){b.defaults.headers.get||(b.defaults.headers.get={}),b.defaults.headers.get["Cache-Control"]="no-cache",b.defaults.headers.get.Pragma="no-cache",a.when("/home",{templateUrl:"/mobile/home",controller:"MobileHomeCtrl as vm"}).when("/exp",{templateUrl:"/mobile/exp"}).when("/recharge",{templateUrl:"/mobile/recharge"}).when("/download",{templateUrl:"/mobile/download"}).when("/login",{templateUrl:"/mobile/login",controller:"MobileLoginCtrl as vm"}).when("/signup",{templateUrl:"/mobile/signup",controller:"MobileSignupCtrl as vm"}).when("/ttn",{templateUrl:"/mobile/ttn",controller:"MobileTtnCtrl as vm"}).when("/ttn_confirm/:apply_serial_id",{templateUrl:function(a){return"/mobile/ttn_confirm/"+a.apply_serial_id},controller:"MobileTtnConfirmCtrl as vm"}).when("/forget",{templateUrl:"/mobile/forget",controller:"MobileForgetCtrl as vm"}).when("/change_pass",{templateUrl:"/mobile/change_password",controller:"MobileChangePassCtrl as vm"}).when("/user",{templateUrl:"/mobile/user",controller:"MobileUserCtrl as vm"}).when("/account",{templateUrl:"/mobile/account",controller:"MobileUserCtrl as vm"}).when("/recharge_bank",{templateUrl:"/mobile/recharge_bank",controller:"MobileRechargeCtrl as vm"}).when("/recharge_alipay",{templateUrl:function(a){return a.order_id?"/mobile/recharge_alipay?order_id="+a.order_id:"/mobile/recharge_alipay"},controller:"MobileRechargeCtrl as vm"}).when("/recharge_record",{templateUrl:"/mobile/recharge_record",controller:"MobileRechargeRecordCtrl as vm"}).when("/user_ttn",{templateUrl:"/mobile/user_ttn",controller:"MobileApplyListCtrl as vm"}).when("/user_ttn_info/:apply_serial_id",{templateUrl:function(a){return"/mobile/user_ttn_info/"+a.apply_serial_id},controller:"MobileApplyDetailCtrl as vm"}).otherwise({redirectTo:"/home"})}]),angular.module("mobileApp").controller("MobileApplyDetailCtrl",["$scope","$window","$location","$http","$timeout","warn_factor","sell_factor","days",function(a,b,c,d,e,f,g,h){var i=this;i.user=b.bootstrappedUserObject,i.showCloseWindow=!1,i.user?(i.apply=b.bootstrappedApplyObject,i.apply.start_date=i.apply.startTime?i.apply.startTime:h.startTime(),i.apply.end_date=i.apply.endTime?i.apply.endTime:h.endTime(i.apply.start_date,i.apply.period),i.days_till_now=h.tradeDaysTillNow(i.apply),i.profit&&(i.finalValue=i.apply.deposit+i.apply.profit,i.finalValue<0&&(i.finalValue=0),i.profit=i.apply.profit>=0?"+":"",i.profit+=i.apply.profit.toString(),i.profit_rate=0,i.apply.profit>0&&(i.profit_rate=i.apply.profit/i.apply.deposit*100)),i.serviceFee=i.apply.isTrial?0:19.9,i.apply_warn=i.apply.isTrial?1800:(f*i.apply.amount).toFixed(2),i.apply_sell=i.apply.isTrial?1600:(g*i.apply.amount).toFixed(2)):(a.data||(a.data={}),a.data.lastLocation="/user_ttn_info",c.path("/login")),i.requestClose=function(){i.showCloseWindow=!0},i.closeApply=function(){d.post("/user/apply_close/"+i.apply.serialID,{}).success(function(){i.apply.status=5,i.resultSuccess=!0,e(function(){i.resultSuccess=!1},2500),i.showCloseWindow=!1}).error(function(){i.errorMsg="结算申请提交失败，请稍后重试",i.resultError=!0,e(function(){i.resultError=!1},2500),i.showCloseWindow=!1})}}]),angular.module("mobileApp").controller("MobileApplyListCtrl",["$scope","$window","njApply","warn_factor","sell_factor","days",function(a,b,c,d,e,f){function g(a){a.start_date=a.startTime?a.startTime:f.startTime(),a.end_date=a.endTime?a.endTime:f.endTime(a.start_date,a.period),a.days_till_now=f.tradeDaysTillNow(a),a.left_days=a.period-a.days_till_now,a.apply_warn=a.isTrial?1800:(d*a.amount).toFixed(2),a.apply_sell=a.isTrial?1600:(e*a.amount).toFixed(2)}var h=this;h.user=b.bootstrappedUserObject,h.apply_list={},h.user?h.apply_list=c.query({uid:h.user._id},function(){angular.forEach(h.apply_list,function(a){g(a)})}):(a.data||(a.data={}),a.data.lastLocation="/recharge_record",$location.path("/login"))}]),angular.module("mobileApp").controller("MobileChangePassCtrl",["$scope","$window","$location","$timeout","$interval","$http",function(a,b,c,d,e,f){var g=this;g.user=b.bootstrappedUserObject,g.user?(g.inputError=!1,g.resetSuccess=!1):(a.data||(a.data={}),a.data.lastLocation="/change_pass",c.path("/login")),g.changePassword=function(){if(!g.password)return g.inputError=!0,g.errorMsg="请输入登录密码，长度6到20位",void d(function(){g.inputError=!1},1500);if(!g.new_password)return g.inputError=!0,g.errorMsg="请输入新密码，长度6到20位",void d(function(){g.inputError=!1},1500);if(!g.confirm_password)return g.inputError=!0,g.errorMsg="请输入再输入一遍新密码",void d(function(){g.inputError=!1},1500);if(g.password===g.new_password)return g.inputError=!0,g.errorMsg="新密码不能与原密码相同",void d(function(){g.inputError=!1},1500);if(g.new_password!==g.confirm_password)return g.inputError=!0,g.errorMsg="两次输入的新密码不同",void d(function(){g.inputError=!1},1500);var a={password:g.password,new_password:g.new_password,confirm_password:g.confirm_password};f.post("/user/reset_pass",a).success(function(){g.resetSuccess=!0,d(function(){g.resetSuccess=!1,c.path("/account")},2500),console.log("success")}).error(function(a){g.inputError=!0,g.errorMsg=a.error_msg,d(function(){g.inputError=!1},1500)})}}]),angular.module("mobileApp").controller("MobileForgetCtrl",["$location","$timeout","$interval","$http",function(a,b,c,d){var e=this;e.showPass=!1,e.nextStep=!1,e.signupError=!1,e.verifyCodeBtnText="获取验证码",e.verifyBtnDisabled=!1,e.resetSuccess=!1,e.getVerifyCode=function(a){if(!e.verifyBtnDisabled){e.verifyBtnDisabled=!0;var b=0;e.verifyCodeBtnText="60秒后重试";var f=c(function(){++b,e.verifyCodeBtnText=60-b+"秒后重试",60===b&&(c.cancel(f),e.verifyCodeBtnText="获取验证码",e.verifyBtnDisabled=!1)},1e3),g=a?2:1;d.get("/api/send_sms_verify_code?mobile="+e.mobile+"&type="+g).success(function(){}).error(function(){})}},e.requestVerifyCode=function(){return e.mobile?void e.getVerifyCode(!0):(e.signupError=!0,e.errorMsg="请输入正确的手机号",void b(function(){e.signupError=!1},1500))},e.requestChangePassNext=function(){return e.mobile?e.verify_code?void(e.nextStep=!0):(e.errorMsg="请输入验证码",e.signupError=!0,void b(function(){e.signupError=!1},1500)):(e.signupError=!0,e.errorMsg="请输入正确的手机号",void b(function(){e.signupError=!1},1500))},e.requestChangePass=function(){return e.password?(e.confirm_password=e.password,void d.post("/forgot",{mobile:e.mobile,verify_code:e.verify_code,password:e.password,confirm_password:e.confirm_password}).success(function(){e.resetSuccess=!0,e.mobile="",e.verify_code="",e.password="",e.confirm_password="",b(function(){a.path("/")},2e3)}).error(function(a){e.signupError=!0,e.errorMsg=a.error_msg,b(function(){e.signupError=!1},1500)})):(e.signupError=!0,e.errorMsg="请输入密码，长度6到20位",void b(function(){e.signupError=!1},1500))},e.toggleShowPassword=function(){var a=$("#J_forgetSetPassword");e.showPass?a.attr("type","text"):a.attr("type","password")}}]),angular.module("mobileApp").controller("MobileHomeCtrl",["$scope","$window",function(){var a=this;a.menu=1}]),angular.module("mobileApp").controller("MobileIndexCtrl",["$scope","$window",function(a,b){a.data={},a.data.currentUser=b.bootstrappedUserObject}]),angular.module("mobileApp").controller("MobileLoginCtrl",["$scope","$location","$window","$timeout","$http",function(a,b,c,d,e){var f=this;f.loginError=!1,f.login=function(){return f.mobile&&f.password?void e.post("/api/login",{mobile:f.mobile,password:f.password}).success(function(d){a.data||b.path(d.location?d.location:"/user"),c.bootstrappedUserObject=d.user,b.path(a.data.lastLocation?a.data.lastLocation:"/exp")}).error(function(a){console.log("login error "+a.error_msg)}):(f.loginError=!0,void d(function(){f.loginError=!1},1500))}}]),angular.module("mobileApp").controller("MobileRechargeCtrl",["$scope","$window","$http","$timeout","$location","njOrder",function(a,b,c,d,e,f){var g=this;g.user=b.bootstrappedUserObject,g.user?(g.smsSend=!1,g.inputError=!1,g.alipayConfirm=!1,g.orderCreateSuccess=!1,g.pay_order=b.bootstrappedOrderObject,g.pay_order&&(g.pay_amount=Number(g.pay_order.amount.toFixed(2)))):(a.data||(a.data={}),a.data.lastLocation="/user",e.path("/login")),g.sendSMSBankInfo=function(){if(!g.smsSend){g.smsSend=!0;var a="户名：北京小牛普惠科技有限公司，账号：110912609510501，开户行：招商银行股份有限公司北京清华园支行";c.post("/api/send_sms",{sms_content:a}).success(function(){console.log("success")}).error(function(){console.log("fail")})}},g.aliPay=function(){if(!g.alipay_account)return g.errorMsg="请输入支付宝账户",g.inputError=!0,void d(function(){g.inputError=!1},1500);if(!g.pay_amount||g.pay_amount<0)return g.errorMsg="请输入有效的充值金额",g.inputError=!0,void d(function(){g.inputError=!1},1500);g.alipayConfirm=!0;var a=new f({uid:g.user._id});a.userID=g.user._id,a.userMobile=g.user.mobile,a.dealType=1,a.amount=Number(g.pay_amount.toFixed(2)),a.description="支付宝转账(移动)",a.payType=3,a.status=2,a.otherInfo=g.alipay_account,a.$save(function(){},function(){g.errorMsg="服务暂时不可用，请稍后再试",g.inputError=!0,d(function(){g.inputError=!1},1500)})},g.confirmAlipay=function(){g.orderCreateSuccess=!0},g.finish=function(){e.path("/recharge")}}]),angular.module("mobileApp").controller("MobileRechargeRecordCtrl",["$scope","$window","$resource",function(a,b,c){var d=this;if(d.user=b.bootstrappedUserObject,d.orderList={},d.user){var e=c("/api/alipay/orders",{});d.orderList=e.query(function(){})}else a.data||(a.data={}),a.data.lastLocation="/recharge_record",$location.path("/login")}]),angular.module("mobileApp").controller("MobileSignupCtrl",["$scope","$location","$timeout","$http","$interval",function(a,b,c,d,e){var f=this;f.signupError=!1,f.verifyCodeBtnText="获取验证码",f.verifyBtnDisabled=!1,f.signup=function(){if(!f.mobile)return f.signupError=!0,f.errorMsg="请输入正确的手机号",void c(function(){f.signupError=!1},1500);if(!f.password)return f.signupError=!0,f.errorMsg="请输入密码，长度6到20位",void c(function(){f.signupError=!1},1500);if(!f.confirm_password)return f.signupError=!0,f.errorMsg="请再输一遍密码，长度6到20位",void c(function(){f.signupError=!1},1500);if(f.password!=f.confirm_password)return f.signupError=!0,f.errorMsg="两次密码应该保持一致",void c(function(){f.signupError=!1},1500);var a={mobile:f.mobile,password:f.password,confirm_password:f.confirm_password};d.post("/api/signup",a).success(function(){f.show_verify_window=!0,f.getVerifyCode()}).error(function(a){f.errorMsg=a.error_msg,f.signupError=!0,c(function(){f.signupError=!1},1500)})},f.getVerifyCode=function(a){if(!f.verifyBtnDisabled){f.verifyBtnDisabled=!0;var b=0;f.verifyCodeBtnText="60秒后重试";var c=e(function(){++b,f.verifyCodeBtnText=60-b+"秒后重试",60===b&&(e.cancel(c),f.verifyCodeBtnText="获取验证码",f.verifyBtnDisabled=!1)},1e3),g=a?2:1;d.get("/api/send_sms_verify_code?mobile="+f.mobile+"&type="+g).success(function(){}).error(function(){})}},f.confirmVerifyCode=function(){return f.verify_code?4!=f.verify_code.length?(f.errorMsg="验证码错误，请重新输入",f.signupError=!0,void c(function(){f.signupError=!1},1500)):void d.post("/finish_signup",{mobile:f.mobile,verify_code:f.verify_code}).success(function(){f.signupSuccess=!0,c(function(){b.path("/")},2e3)}).error(function(a){f.errorMsg=a.error_msg,f.signupError=!0,c(function(){f.signupError=!1},1500)}):(f.errorMsg="请输入验证码",f.signupError=!0,void c(function(){f.signupError=!1},1500))}}]),angular.module("mobileApp").controller("MobileTtnConfirmCtrl",["$scope","$window","$location","$http","days","service_charge",function(a,b,c,d,e,f){function g(){h.serviceFee=h.apply.amount/1e4*f*h.apply.period,h.totalAmount=h.apply.deposit+h.serviceFee,h.shouldPay=h.totalAmount-h.apply.userBalance,h.shouldPay<=0?(h.shouldPay=0,h.balancePay=!0):h.balancePay=!1}var h=this;h.apply={},b.bootstrappedApplyObject&&angular.extend(h.apply,b.bootstrappedApplyObject),h.validDays=[2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],g(),h.selectDay=function(){g()},h.payForApply=function(){h.apply.shouldPay=h.shouldPay,h.apply.totalAmount=h.totalAmount,d.post("/apply_confirm",h.apply).success(function(a){if(console.log("success"),0===h.shouldPay){var c={apply_serial_id:a.apply.serialID,order_id:a.order._id};d.post("/api/users/pay_by_balance",c).success(function(){b.location.assign("/mobile/apply/pay_success?serial_id="+a.apply.serialID+"&amount="+a.apply.amount)}).error(function(a){console.log("error:"+a.error_msg)})}else b.location.assign("/mobile/#/recharge_alipay?order_id="+a.order._id)}).error(function(a){console.log("error:"+a.reason)})}}]),angular.module("mobileApp").controller("MobileTtnCtrl",["$scope","$window","$location","$http","days",function(a,b,c,d,e){function f(){j.summary.warnValue=j.summary.amount*k,j.summary.sellValue=j.summary.amount*l,j.summary.deposit=j.summary.amount*m;var a=j.summary.amount/1e4*n;j.summary.charge=a,j.summary.total=j.summary.deposit+a,j.endTime=e.endTime(o,j.summary.day)}function g(){angular.forEach(j.amountList,function(a){a.select=!1})}function h(){j.otherAmount>=j.min_amount?j.otherAmount<=j.max_amount?j.summary.amount=Math.floor(j.otherAmount):j.otherAmount=j.summary.amount=j.max_amount:j.summary.amount=0,f()}function i(){d.post("/apply",j.summary).success(function(a){console.log("success "+a.apply_serial_id),c.path("/ttn_confirm/"+a.apply_serial_id)}).error(function(b,d){401===d?(a.data.lastLocation="/ttn",c.path("/login")):console.log(b.error_msg)})}var j=this;j.min_amount=2e3,j.max_amount=3e5;var k=.96,l=.94,m=.1,n=19.9,o=e.startTime();j.agree=!0,j.showOtherAmount=!1,j.otherAmount,j.summary={day:1,amount:2e3},j.endTime=e.endTime(o,j.summary.day),f(),j.amountList=[{name:"2000元",value:"2000",select:!0},{name:"1万",value:"10000"},{name:"2万",value:"20000"},{name:"3万",value:"30000"},{name:"5万",value:"50000"},{name:"10万",value:"100000"},{name:"20万",value:"200000"},{name:"30万",value:"300000"}],j.selectAmount=function(a){g(),j.showOtherAmount=!1,a.select=!0,j.summary.amount=a.value,f()},j.toggleOtherAmount=function(){j.showOtherAmount=!j.showOtherAmount,j.showOtherAmount?h():j.selectAmount(j.amountList[0])},j.finishOtherAmount=function(){h()},j.submitApply=function(){return j.agree?j.summary.amount<=0||j.summary.amount>3e5?void alert("金额必须在2000元到30万之间"):void i():void alert("您必须同意《牛金操盘协议》")}}]),angular.module("mobileApp").controller("MobileUserCtrl",["$scope","$window","$location","$http",function(a,b,c,d){var e=this;e.user=b.bootstrappedUserObject,e.user||(a.data||(a.data={}),a.data.lastLocation="/user",c.path("/login")),e.menu=4,e.logout=function(){d.post("/logout",{}).success(function(){a.data.currentUser=null,b.bootstrappedUserObject=null,c.path("/")}).error(function(){})}}]);