"use strict";angular.module("applyApp",[]),angular.module("applyApp").controller("ApplyController",["$http","$location","$window",function(a,b,c){function d(){h.summary.warnValue=h.summary.amount*i,h.summary.sellValue=h.summary.amount*j,h.summary.deposit=h.summary.amount*k;var a=h.summary.amount/1e4*l*h.summary.day;h.summary.charge=a,h.summary.total=h.summary.deposit+a}function e(){angular.forEach(h.amountList,function(a){a.select=!1})}function f(){angular.forEach(h.dayList,function(a){a.select=!1})}function g(){h.summary.amount=h.otherAmount>=2e3?Math.floor(h.otherAmount):h.otherAmount=2e3,d()}var h=this,i=.93,j=.95,k=.1,l=18.8;h.agree=!0,h.showOtherAmount=!1,h.otherAmount=2e3,h.summary={day:5,amount:5e4},d(),h.amountList=[{name:"2000元",value:"2000"},{name:"1万",value:"10000"},{name:"3万",value:"30000"},{name:"5万",value:"50000",select:!0},{name:"10万",value:"100000"},{name:"30万",value:"300000"}],h.dayList=[{value:"2"},{value:"5",select:!0},{value:"8"},{value:"10"}],h.selectAmount=function(a){e(),h.showOtherAmount=!1,h.otherAmount=0,a.select=!0,h.summary.amount=a.value,d()},h.selectDay=function(a){f(),a.select=!0,h.summary.day=a.value,d()},h.toggleOtherAmount=function(){e(),h.showOtherAmount=!h.showOtherAmount,g()},h.finishOtherAmount=function(){g()},h.submitApply=function(){a.post("/apply",h.summary).then(function(a){a.data.success?c.location.href="/apply_confirm/"+a.data.apply_id:"not authenticate"===a.data.reason&&(c.location.href="/login")})}}]),$(document).ready(function(){function a(a){$.aibei_mask({tip:"loading"}),$.aibei_showIframePayWindow(a,"window.aibeiNotify"),$.aibei_unmask(),$("#pay-confirm").modal({relatedTarget:this,onConfirm:function(){var a=$("#apply_id")[0]?$("#apply_id")[0].value:null;window.location.replace(a?"/thank_you_for_pay?apply_id="+a:"/thank_you_for_pay")},onCancel:function(){window.location.replace("/support_contact")}})}function b(b,c,d){var e=$("#trans_id")[0]?$("#trans_id")[0].value:null,f={id:b,uid:c,price:d};return window.niujin_data={},window.niujin_data.paying_order=f,e?void a(e):void $.post("/api/user_pay",f,function(b){b.success?(console.log(b.transid),a(b.transid)):console.log("error")})}function c(a,c,d){var e={userID:a,dealType:"充值",amount:c,description:"股票配资"};$.ajax({url:"/api/user/"+a+"/orders?aid="+d,type:"POST",dataType:"json",data:e,success:function(d){console.log(d._id),b(d._id,a,c)},error:function(a){console.log(a)}})}function d(){console.log("payByShengpay");var a=$("#Name")[0].value,b=$("#Version")[0].value,c=$("#Charset")[0].value,d=$("#MsgSender")[0].value,e=$("#OrderNo")[0].value,f=$("#OrderAmount")[0].value,g=$("#OrderTime")[0].value,h=$("#PageUrl")[0].value,i=$("#BackUrl")[0].value,j=$("#NotifyUrl")[0].value,k=returnCitySN.cip,l=$("#ProductName")[0].value,m=$("#SignType")[0].value,n="shengfutongSHENGFUTONGtest",o=a+b+c+d+e+f+g+h+i+j+l+k+m+n,p=SparkMD5.hash(o);p=p.toUpperCase(),console.log(p),$("#BuyerIp")[0].value=k,$("#SignMsg")[0].value=p,$("#shengPayForm")[0].submit()}moment.locale("zh-cn"),$(".verify-code-btn").click(function(){var a=$(this),b=$("#mobile")[0].value;if(!b||0!==b.search(/1[3|5|7|8|][0-9]{9}$/))return void $("#correct-mobile-alert").modal({});var c=0;a.addClass("am-disabled"),a[0].innerText="60秒后重试";var d=setInterval(function(){++c,a[0].innerText=60-c+"秒后重试",60===c&&(clearInterval(d),a[0].innerText="获取验证码",a.removeClass("am-disabled"))},1e3),e={mobile:b.trim()};$.get("/api/send_sms_verify_code",e,function(a){console.log(a)})}),window.aibeiNotify=function(a){if(console.log("RetCode="+a.RetCode+":TransId="+a.TransId+":OrderStatus="+a.OrderStatus),0===a.RetCode)if(console.log("pay complete"),0===a.OrderStatus){console.log("pay success");var b=$("#apply_id")[0]?$("#apply_id")[0].value:null;if(window.niujin_data&&window.niujin_data.paying_order){var c=window.niujin_data.paying_order.id,d=window.niujin_data.paying_order.price;window.niujin_data.paying_order=null,$.post("/api/users/pay_success/"+c,{pay_amount:d},function(a){a.success?b?$.post("/api/users/pay_by_balance",{pay_amount:d,apply_id:b},function(a){console.log(a.success?"success to pay for apply":"failed to pay for apply")}):console.log("pay success"):console.log("failed to update user balance after pay success")})}}else console.log("pay failed")},$("#go-to-pay").on("click",function(a){a.preventDefault();var e=$("#user_id")[0].value,f=$("#pay_amount")[0].value,g=$("#apply_id")[0]?$("#apply_id")[0].value:null,h=$("#order_id")[0]?$("#order_id")[0].value:null,i=$("#pay-select")[0].value;return console.log("pay option:"+i),"option1"===i?void d():void(h?b(h,e,f):c(e,f,g))}),$("#go-to-use-balance").on("click",function(a){a.preventDefault();var b=$("form").serialize();$.post("/api/users/pay_by_balance",b,function(a){window.location.replace(a.success?"/thank_you_for_pay":"/failed_to_pay")})})});