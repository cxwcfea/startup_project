"use strict";!function(){var a=[moment("2015-03-14").dayOfYear(),moment("2015-03-15").dayOfYear(),moment("2015-03-21").dayOfYear(),moment("2015-03-22").dayOfYear(),moment("2015-03-28").dayOfYear(),moment("2015-03-29").dayOfYear(),moment("2015-04-04").dayOfYear(),moment("2015-04-05").dayOfYear(),moment("2015-04-06").dayOfYear(),moment("2015-04-11").dayOfYear(),moment("2015-04-12").dayOfYear(),moment("2015-04-18").dayOfYear(),moment("2015-04-19").dayOfYear(),moment("2015-04-25").dayOfYear(),moment("2015-04-26").dayOfYear(),moment("2015-05-01").dayOfYear(),moment("2015-05-02").dayOfYear(),moment("2015-05-03").dayOfYear(),moment("2015-05-09").dayOfYear(),moment("2015-05-10").dayOfYear(),moment("2015-05-16").dayOfYear(),moment("2015-05-17").dayOfYear(),moment("2015-05-23").dayOfYear(),moment("2015-05-24").dayOfYear(),moment("2015-06-06").dayOfYear(),moment("2015-06-07").dayOfYear(),moment("2015-06-13").dayOfYear(),moment("2015-06-14").dayOfYear(),moment("2015-06-20").dayOfYear(),moment("2015-06-21").dayOfYear(),moment("2015-06-22").dayOfYear(),moment("2015-06-27").dayOfYear(),moment("2015-06-28").dayOfYear(),moment("2015-07-04").dayOfYear(),moment("2015-07-05").dayOfYear(),moment("2015-07-11").dayOfYear(),moment("2015-07-12").dayOfYear(),moment("2015-07-18").dayOfYear(),moment("2015-07-19").dayOfYear(),moment("2015-07-25").dayOfYear(),moment("2015-07-26").dayOfYear(),moment("2015-08-01").dayOfYear(),moment("2015-08-02").dayOfYear(),moment("2015-08-08").dayOfYear(),moment("2015-08-09").dayOfYear(),moment("2015-08-15").dayOfYear(),moment("2015-08-16").dayOfYear(),moment("2015-08-22").dayOfYear(),moment("2015-08-23").dayOfYear(),moment("2015-08-29").dayOfYear(),moment("2015-08-30").dayOfYear(),moment("2015-09-05").dayOfYear(),moment("2015-09-06").dayOfYear(),moment("2015-09-12").dayOfYear(),moment("2015-09-13").dayOfYear(),moment("2015-09-19").dayOfYear(),moment("2015-09-20").dayOfYear(),moment("2015-09-26").dayOfYear(),moment("2015-09-27").dayOfYear(),moment("2015-10-01").dayOfYear(),moment("2015-10-02").dayOfYear(),moment("2015-10-03").dayOfYear(),moment("2015-10-04").dayOfYear(),moment("2015-10-05").dayOfYear(),moment("2015-10-06").dayOfYear(),moment("2015-10-07").dayOfYear(),moment("2015-10-10").dayOfYear(),moment("2015-10-11").dayOfYear(),moment("2015-10-17").dayOfYear(),moment("2015-10-18").dayOfYear(),moment("2015-10-24").dayOfYear(),moment("2015-10-25").dayOfYear(),moment("2015-10-31").dayOfYear(),moment("2015-11-01").dayOfYear(),moment("2015-11-07").dayOfYear(),moment("2015-11-08").dayOfYear(),moment("2015-11-14").dayOfYear(),moment("2015-11-15").dayOfYear(),moment("2015-11-21").dayOfYear(),moment("2015-11-22").dayOfYear(),moment("2015-11-28").dayOfYear(),moment("2015-11-29").dayOfYear(),moment("2015-12-05").dayOfYear(),moment("2015-12-06").dayOfYear(),moment("2015-12-12").dayOfYear(),moment("2015-12-13").dayOfYear(),moment("2015-12-19").dayOfYear(),moment("2015-12-20").dayOfYear(),moment("2015-12-26").dayOfYear(),moment("2015-12-27").dayOfYear()],b=function(){var b=moment().startOf("day");for((moment().hour()>14||14==moment().hour()&&moment().minute()>=30)&&(b=moment().endOf("day").add(1,"ms"));;){var c=b.dayOfYear();if(-1===a.indexOf(c))break;b=b.add(1,"day")}return b},c=function(b,c){--c;for(var d=b.clone();c;)d=d.add(1,"day"),-1===a.indexOf(d.dayOfYear())&&--c;return d.hour(14),d.minute(54),d.second(59),d},d=function(b,c){var d=moment(b).dayOfYear(),e=0;for(--c;c;)-1===a.indexOf(d)&&--c,--d,++e;return e};angular.module("commonApp",[]),angular.module("commonApp").value("gbToastr",toastr),angular.module("commonApp").factory("gbNotifier",["gbToastr",function(a){return{notify:function(b){a.success(b)},error:function(b){a.error(b)}}}]),angular.module("commonApp").filter("displayDate",function(){return function(a){return moment(a).format("YYYY-MM-DD HH:mm")}}).filter("orderStatus",function(){return function(a){return a?"交易成功":"等待确认"}}).filter("displayOrderType",function(){return function(a){switch(a){case 1:return"充值";case 2:return"提现";case 3:return"盈利提取";case 4:return"股票盈利";case 5:return"保证金返还";case 6:return"追加配资保证金";default:return"充值"}}}).filter("applyStatus",function(){return function(a){switch(a){case 1:return"待支付";case 2:return"操盘中";case 3:return"已结算";case 4:return"审核中";case 5:return"结算中";default:return"待支付"}}}).service("days",function(){this.startTime=b,this.endTime=c,this.tradeDaysFromEndDay=d}),angular.module("commonApp").constant("withdraw_sms_content","您的提现申请已经处理，资金即将到账").constant("get_profit_sms_content","您的盈利提取申请已经处理，资金已划入您在牛金网的余额")}(),$(document).ready(function(){function a(a){$.aibei_mask({tip:"loading"}),$.aibei_showIframePayWindow(a,"window.aibeiNotify"),$.aibei_unmask(),$("#pay-confirm").modal({relatedTarget:this,onConfirm:function(){var a=$("#apply_id")[0]?$("#apply_id")[0].value:null;window.location.replace(a?"/thank_you_for_pay?apply_id="+a:"/thank_you_for_pay")},onCancel:function(){window.location.replace("/support_contact")}})}function b(b,c,d){var e=$("#trans_id")[0]?$("#trans_id")[0].value:null,f={id:b,uid:c,price:d};e?a(e):$.post("/user/iapp_pay",f,function(b){b.success?(console.log(b.transid),a(b.transid)):console.log("error")})}function c(a,c,e,f){var g={userID:a,dealType:1,amount:c,applySerialID:e,description:"股票配资"};$.ajax({url:"/api/user/"+a+"/orders?aid="+e,type:"POST",dataType:"json",data:g,success:function(e){1===f?d(e._id):b(e._id,a,c)},error:function(a){console.log(a)}})}function d(a){console.log("payByShengpay");var b=$("#Name")[0].value,c=$("#Version")[0].value,d=$("#Charset")[0].value,e=$("#MsgSender")[0].value;a&&($("#OrderNo")[0].value=a);var f=$("#OrderNo")[0].value,g=$("#OrderAmount")[0].value,h=$("#OrderTime")[0].value,i=$("#PageUrl")[0].value,j=$("#BackUrl")[0].value,k=$("#NotifyUrl")[0].value,l=returnCitySN.cip,m=$("#ProductName")[0].value,n=$("#SignType")[0].value,o="shengfutongSHENGFUTONGtest",p=b+c+d+e+f+g+h+i+j+k+m+l+n+o,q=SparkMD5.hash(p);q=q.toUpperCase(),$("#BuyerIp")[0].value=l,$("#SignMsg")[0].value=q,$("#shengPayForm")[0].submit()}moment.locale("zh-cn"),$(".verify-code-btn").click(function(){var a=$(this),b=$("#mobile")[0].value;if(!b||0!==b.search(/1[3|5|7|8|][0-9]{9}$/))return void $("#correct-mobile-alert").modal({});var c=0;a.addClass("am-disabled"),a[0].innerText="60秒后重试";var d=setInterval(function(){++c,a[0].innerText=60-c+"秒后重试",60===c&&(clearInterval(d),a[0].innerText="获取验证码",a.removeClass("am-disabled"))},1e3),e={mobile:b.trim()};$.get("/api/send_sms_verify_code",e,function(a){console.log(a)})}),window.aibeiNotify=function(a){console.log("RetCode="+a.RetCode+":TransId="+a.TransId+":OrderStatus="+a.OrderStatus),0===a.RetCode&&(console.log("iapp pay complete"),console.log(0===a.OrderStatus?"iapp pay success":"iapp pay failed"))},$("#go-to-pay").on("click",function(a){a.preventDefault();var e=$("#user_id")[0].value,f=$("#pay_amount")[0].value,g=$("#apply_id")[0]?$("#apply_id")[0].value:null,h=$("#order_id")[0]?$("#order_id")[0].value:null,i=$("#pay-select")[0].value;return console.log("pay option:"+i),"option1"===i?void(h?d():c(e,f,g,1)):void(h?b(h,e,f):c(e,f,g,0))}),$("#go-to-use-balance").on("click",function(a){a.preventDefault();var b=$("form").serialize();$.post("/api/users/pay_by_balance",b,function(a){window.location.replace(a.success?"/thank_you_for_pay":"/failed_to_pay")})}),$("#close-apply").on("click",function(a){a.preventDefault(),$("#close-apply-prompt").modal({relatedTarget:this,onConfirm:function(){var a=$("#apply_serial_id")[0].value;$.post("/user/apply_close/"+a,{},function(a){console.log(a),window.location.replace(a.success?"/user/apply_close":"/support_contact")})},onCancel:function(){console.log("cancel")}})}),$("#get-profit").on("click",function(a){a.preventDefault();var b=$("#apply_serial_id")[0].value;window.location.assign("/apply/get_profit/"+b)});var e={onValid:function(){console.log("form trigger")},onInValid:function(){$("#get-profit-btn").popover({content:"请输入有效的金额"}),$("#add-deposit-btn").popover({content:"请输入有效的金额"})}};$("#get-profit-form").validator(e),$("#add-deposit-form").validator(e),$("#add-deposit").on("click",function(a){a.preventDefault();var b=$("#apply_serial_id")[0].value;window.location.assign("/apply/add_deposit/"+b)})}),angular.module("myApp").factory("gbIdentity",["$window",function(a){var b;return a.bootstrappedUserObject&&(b={},angular.extend(b,a.bootstrappedUserObject)),{currentUser:b}}]),function(){angular.module("applyApp",["commonApp"]),angular.module("applyApp").controller("ApplyController",["$http","$location","$window","days",function(a,b,c,d){function e(){i.summary.warnValue=i.summary.amount*j,i.summary.sellValue=i.summary.amount*k,i.summary.deposit=i.summary.amount*l;var a=i.summary.amount/1e4*m*i.summary.day;i.summary.charge=a,i.summary.total=i.summary.deposit+a}function f(){angular.forEach(i.amountList,function(a){a.select=!1})}function g(){angular.forEach(i.dayList,function(a){a.select=!1})}function h(){i.summary.amount=i.otherAmount>=2e3?Math.floor(i.otherAmount):i.otherAmount=2e3,e()}var i=this,j=.93,k=.95,l=.1,m=18.8;i.agree=!0,i.showOtherAmount=!1,i.otherAmount=2e3,i.summary={day:5,amount:5e4},i.startTime=d.startTime(),e(),i.amountList=[{name:"2000元",value:"2000"},{name:"1万",value:"10000"},{name:"3万",value:"30000"},{name:"5万",value:"50000",select:!0},{name:"10万",value:"100000"},{name:"30万",value:"300000"}],i.dayList=[{value:"2"},{value:"5",select:!0},{value:"8"},{value:"10"}],i.selectAmount=function(a){f(),i.showOtherAmount=!1,i.otherAmount=0,a.select=!0,i.summary.amount=a.value,e()},i.selectDay=function(a){g(),a.select=!0,i.summary.day=a.value,e()},i.toggleOtherAmount=function(){f(),i.showOtherAmount=!i.showOtherAmount,h()},i.finishOtherAmount=function(){h()},i.submitApply=function(){a.post("/apply",i.summary).then(function(a){a.data.success?c.location.href="/apply_confirm/"+a.data.apply_id:"not authenticate"===a.data.reason&&(c.location.href="/login")})}}])}(),angular.module("myApp").controller("UserApplyListController",["gbIdentity","$http","gbNotifier","$location","gbApply","$window","days",function(a,b,c,d,e,f,g){function h(){k.totalItems=l.length,k.currentPage=1,k.pageChanged()}function i(){m=e.query({uid:k.user._id},function(){angular.forEach(m,function(a){j(a)}),l=m,h()}),k.queryItems=[{name:"全部",value:0},{name:"待支付",value:1},{name:"当前操盘",value:2},{name:"已结算",value:3},{name:"审核中",value:4},{name:"结算中",value:5}]}function j(a){a.start_date=a.startTime?a.startTime:g.startTime(),a.end_date=a.endTime?a.endTime:g.endTime(a.start_date,a.period)}var k=this;k.user=a.currentUser;var l,m={};k.itemsPerPage=15,i(),k.queryItem=function(a){l=m.filter(function(b){return a.value?b.status===a.value:!0}),h()},k.pageChanged=function(){var a=(k.currentPage-1)*k.itemsPerPage,b=a+k.itemsPerPage;b>k.totalItems&&(b=k.totalItems),k.showingItems=l.slice(a,b)},k.manageApply=function(a){1===a.status?f.location.assign("/apply_confirm/"+a.serialID):3===a.status?c.notify("该配资已经结算"):f.location.assign("/apply_detail/"+a.serialID)}}]),angular.module("myApp").controller("UserEmailController",["gbIdentity","$http","gbNotifier","$location",function(a,b,c){var d=this;d.user=a.currentUser,d.verifyEmail=function(){console.log("verify email"),b.post("/user/verify_email",{email:d.user.profile.email}).then(function(a){a.data.success?c.notify("email send success"):c.error("email send fail "+a.data.reason)})}}]),angular.module("myApp").controller("UserIdentityController",["gbIdentity","$http","gbNotifier","$location",function(a,b,c,d){var e=this;e.user=a.currentUser,e.submitRequest=function(){b.post("/api/users/"+e.user._id,{identity:e.user.identity}).then(function(a){a.data.success?(c.notify("实名认证成功"),d.path("/security")):c.error("实名认证失败")})}}]),angular.module("myApp").controller("UserIndexController",["$location","$http",function(a,b){var c=this;c.gotoRoot=function(){window.location="/"},c.signout=function(){b.post("/logout",{logout:!0}).then(function(){window.location="/"})}}]),angular.module("myApp").controller("UserMainController",["gbIdentity",function(a){var b=this;b.user=a.currentUser,b.displayName=function(){return b.user.profile.name?b.user.profile.name:b.user.mobile},b.registerDate=function(){return moment(b.user.registerAt).format("ll")}}]),angular.module("myApp").controller("UserOrderController",["$window","gbIdentity","gbOrder",function(a,b,c){function d(){g=c.query({uid:h.user._id},function(){f=g,e()}),h.queryItems=[{name:"全部",value:0},{name:"充值",value:1},{name:"提现",value:2},{name:"盈利提取",value:3},{name:"股票盈利",value:4},{name:"保证金返还",value:5}]}function e(){h.totalItems=f.length,h.currentPage=1,h.pageChanged()}var f,g,h=this;h.user=b.currentUser,h.itemsPerPage=15,h.queryItem=function(a){f=g.filter(function(b){return a.value?b.dealType===a.value:!0}),e()},h.pageChanged=function(){var a=(h.currentPage-1)*h.itemsPerPage,b=a+h.itemsPerPage;b>h.totalItems&&(b=h.totalItems),h.showingItems=f.slice(a,b)},h.manageOrder=function(b){b.status||1!==b.dealType||a.location.assign("/pay_confirm/"+b._id)},d()}]),angular.module("myApp").controller("UserPayController",["gbIdentity","$http","gbNotifier","$window","gbOrder",function(a,b,c,d,e){var f=this;f.user=a.currentUser,f.pay_option="option1",f.gotoPay=function(){if(!f.payAmount||f.payAmount<0)return void c.error("无效的充值金额");var a={userID:f.user._id,dealType:1,amount:f.payAmount,description:"网站充值"},b=new e(a);b.$save().then(function(){c.notify("订单提交成功");var a=1;"option2"===f.pay_option&&(a=2),d.location.assign("/pay_confirm/"+b._id+"?pay_option="+a)},function(a){c.error("订单提交失败 "+a.data.reason)})}}]),angular.module("myApp").controller("UserProfileController",["gbIdentity","gbNotifier","$http",function(a,b,c){var d=this;d.user=a.currentUser,d.updateUserProfile=function(){c.post("/api/users/"+d.user._id,{profile:d.user.profile}).then(function(a){a.data.success?b.notify("个人信息更新成功"):b.error("个人信息更新失败")})}}]),angular.module("myApp").controller("UserResetPasswordController",["gbIdentity","$http","gbNotifier","$location",function(a,b,c,d){var e=this;e.user=a.currentUser,e.submitRequest=function(){return e.new_pass!==e.confirm_pass?void c.error("两次输入的密码不同"):void b.post("/user/change_pass",{old_password:e.old_pass,password:e.new_pass,confirm_password:e.confirm_pass}).then(function(a){a.data.success?(c.notify("密码设置成功"),d.path("/security")):c.error("密码设置失败："+a.data.reason)})},e.changeFinancePass=function(){return e.new_finance_pass!==e.confirm_finance_pass?void c.error("两次输入的密码不同"):void b.post("/user/change_finance_pass",{password:e.login_pass,new_password:e.new_finance_pass,confirm_password:e.confirm_finance_pass}).then(function(a){a.data.success?(e.user.finance.password=e.new_finance_pass,c.notify("密码设置成功"),d.path("/security")):c.error(a.data.reason)})}}]),angular.module("myApp").controller("UserSecurityController",["gbIdentity",function(a){function b(){c.securityObjects=[{"class":"am-icon-user-secret am-icon-lg",title:"实名认证",status:c.user.identity.id?"已认证":"未认证",url:"/user#/identity",action:"去认证",show:c.user.identity.id?!1:!0},{"class":"am-icon-mobile am-icon-lg",title:"绑定手机",status:"已认证",url:"#",action:"修改",show:!1},{"class":"am-icon-envelope am-icon-lg",title:"验证邮箱",status:c.user.profile.email_verified?"已验证":"未验证",url:"/user#/verify_email",action:"去验证",show:c.user.profile.email_verified?!1:!0},{"class":"am-icon-key am-icon-lg",title:"登录密码",status:"已设置",url:"/user#/change_pass",action:"修改",show:!0},{"class":"am-icon-money am-icon-lg",title:"提现密码",status:c.user.finance.password?"已设置":"未设置",url:"/user#/change_finance_pass",action:c.user.finance.password?"修改":"设置",show:!0}]}var c=this;c.user=a.currentUser,b()}]),angular.module("myApp").controller("UserWithdrawController",["gbIdentity","gbNotifier","$location","gbCard","gbCachedCards","gbOrder","$http",function(a,b,c,d,e,f,g){var h=this;h.user=a.currentUser,h.cards=[],h.card={},h.card.userID=h.user._id,h.user.identity.name&&(h.card.userName=h.user.identity.name),e.setUID(h.user._id),h.cards=e.query(),h.selectCard=function(a){h.selected=a},h.isSelected=function(a){return h.selected===a},h.addCard=function(){var a=/^(\d{16}|\d{19})$/;if(!a.test(h.card.cardID))return void b.error("无效的银行卡号");var c=new d(h.card);c.$save().then(function(){b.notify("添加成功"),h.cards.push(h.card)},function(a){b.error("添加失败 "+a.data.reason)})},h.withdraw=function(){if(h.selected)if(h.amount<=0||h.amount>h.user.finance.balance)b.error("无效的提现金额："+h.amount);else{var a={userID:h.user._id,dealType:2,amount:h.amount,description:"余额提现",cardInfo:{bankName:h.selected.bankName,cardID:h.selected.cardID,userName:h.selected.userName}},c={order:a,password:h.password};g.post("/user/withdraw",c).success(function(){h.user.finance.freeze_capital+=a.amount,h.user.finance.balance-=a.amount,b.notify("您的提现申请已经提交,我们会尽快处理")}).error(function(a){b.error("提现申请提交失败 "+a.reason)})}else b.error("请选择要提现的银行卡")}}]),angular.module("myApp").factory("gbApply",["$resource",function(a){var b=a("/api/applies/:uid/apply/:aid",{userID:"@uid",applyID:"@aid"});return b}]),angular.module("myApp").factory("gbCard",["$resource",function(a){var b=a("/api/cards/:uid",{userID:"@uid"});return b}]),angular.module("myApp").factory("gbOrder",["$resource",function(a){var b=a("/api/user/:uid/orders/:id",{uid:"@userID",id:"@_id"});return b}]),angular.module("myApp").factory("gbCachedCards",["gbCard",function(a){var b,c;return{setUID:function(a){c=a},query:function(){return b||(b=a.query({uid:c})),b}}}]);