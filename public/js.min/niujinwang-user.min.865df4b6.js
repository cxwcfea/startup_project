"use strict";angular.module("userApp",["ngResource","ngRoute","ui.bootstrap","commonApp"]),angular.module("userApp").config(["$routeProvider",function(a){a.when("/index",{templateUrl:"/user/home",controller:"UserHomeCtrl as homeVM"}).when("/apply_detail/:serial_id",{templateUrl:"/user/apply_detail",controller:"UserApplyCtrl as applyVM"}).when("/user_capital",{templateUrl:"/user/user_capital",controller:"UserCapitalCtrl as capitalVM"}).when("/user_account",{templateUrl:"/user/user_account",controller:"UserAccountCtrl as accountVM"}).otherwise({redirectTo:"/index"})}]),angular.module("userApp").controller("UserAccountCtrl",["$scope","$filter","$window","$http","$interval","$location","$timeout",function(a,b,c,d,e,f,g){function h(){i.userInfoItem=[{value:1,title:"身份认证",status:i.user.identity.id?"已认证":"未认证",icon:"spanIcon01",info:i.user.identity.id?i.user.identity.name+"("+b("displayIdentityID")(i.user.identity.id)+")":"",description:"提现必须先进行身份认证",action:"立即认证",show_action:i.user.identity.id?!1:!0},{value:2,title:"手机",status:"已绑定",icon:"spanIcon02",info:b("displayMobile")(i.user.mobile),description:"手机用于接收牛金网的通知信息",action:"修改",show_action:!1},{value:3,title:"邮箱",status:i.user.profile.email_verified?"已绑定":"未绑定",icon:"spanIcon03",info:b("displayEmail")(i.user.profile.email)||"",description:"邮箱用于接受账户的各种信息",action:"邮箱设置",show_action:!0},{value:4,title:"登录密码",status:"",icon:"spanIcon04",info:"",description:"登录密码用于牛金账户的登录",action:"修改",show_action:!0},{value:5,title:"提现密码",status:i.user.finance.password?"已设置":"未设置",icon:"spanIcon05",info:"",description:"提现密码用于确认提现",action:i.user.finance.password?"修改":"设置",show_action:!0}]}var i=this;$(".footer").addClass("marTop200"),a.$on("$routeChangeSuccess",function(){if(0===f.path().indexOf("/user_account")){var a=f.search().category;(!a||a>3)&&(a=0),i.currentCategory=i.categories[a]}});var j="获取手机验证码",k=!1;a.data.menu=3,i.user=a.data.currentUser,i.sendingEmail=!1,i.verifyCodeBtnText=j,i.categories=[{file:"/views/user_info.html",name:"个人资料",menu:0,value:0},{file:"/views/identity.html",name:"身份认证",menu:1,value:1},{file:"/views/set_finance_pass.html",name:"提现密码",menu:2,value:2},{file:"/views/user_email.html",name:"邮箱设置",menu:3,value:3},{file:"/views/email_send_confirmation.html",name:"邮箱确认",menu:3,value:4}],h(),i.alerts=[];var l=function(a,b){i.alerts=[],i.alerts.push({type:a,msg:b})};i.closeAlert=function(a){i.alerts.splice(a,1)},i.selectCategory=function(a){a||(a=i.categories[0]),i.currentCategory=a,i.alerts=[]},i.selectedCategory=function(){return i.currentCategory.file},i.itemAction=function(a){switch(a.value){case 1:i.currentCategory=i.categories[1];break;case 3:i.currentCategory=i.categories[3];break;case 4:c.location.assign("/forgot");break;case 5:i.currentCategory=i.categories[2]}},i.verifyEmail=function(){i.sendingEmail||(i.sendingEmail=!0,d.post("/user/verify_email",{email:i.user.profile.email}).then(function(a){i.sendingEmail=!1,a.data.success?(i.currentCategory=i.categories[4],h()):l("danger","邮件发送失败,请稍后再试")}))},i.verifyUserIdentity=function(){return i.identity_name&&i.identity_id?i.identity_name.length>8?void l("danger","您输入的姓名太长，请重新输入"):(i.user.identity.name=i.identity_name,i.user.identity.id=i.identity_id,void d.post("/api/user/"+i.user._id,i.user).success(function(a){i.user=a,l("success","实名认证成功"),h()}).error(function(){l("danger","实名认证出错,请稍后再试")})):void l("danger","请输入有效的姓名及身份证号")},i.getVerifyCode=function(){if(!k){k=!0;var a=0;i.verifyCodeBtnText="60秒后重试";var b=e(function(){++a,i.verifyCodeBtnText=60-a+"秒后重试",60===a&&(e.cancel(b),i.verifyCodeBtnText=j,k=!1)},1e3);d.get("/api/send_sms_verify_code?mobile="+i.user.mobile).success(function(){l("success","验证码已发送")}).error(function(){l("danger","验证码发送失败，请稍后重试")})}},i.setFinancePassword=function(){return i.finance_pass&&i.confirm_finance_pass&&i.verify_code?i.finance_pass!=i.confirm_finance_pass?void l("danger","两次密码输入不一致"):void d.post("/user/change_finance_pass",{mobile:i.user.mobile,new_password:i.finance_pass,confirm_password:i.confirm_finance_pass,verify_code:i.verify_code}).success(function(){l("success","提现密码设置成功"),i.user.finance.password=i.finance_pass,i.confirm_finance_pass="",i.verify_code="",h(),g(function(){i.currentCategory=i.categories[0]},2e3)}).error(function(a){l("danger",a.error_msg)}):void l("danger","请确保各项输入正确")},i.excludeCategory=function(a){return 4!=a.value},i.setupEmail=function(){return i.user_email?i.user.profile.email&&i.user.profile.email_verified&&i.user.profile.email==i.user_email?void l("danger","该邮箱已经绑定"):(i.user.profile.email=i.user_email,i.user.profile.email_verified=!1,void d.post("/api/user/"+i.user._id,i.user).success(function(){d.post("/user/verify_email",{email:i.user.profile.email}).success(function(){console.log("email send success")}).error(function(){console.log("email send faile")}),i.currentCategory=i.categories[4]}).error(function(){l("danger","设置邮箱时出错,请稍后再试")})):void l("danger","请输入有效的邮箱地址")}}]),angular.module("userApp").controller("UserApplyCtrl",["$scope","$window","$location","$routeParams","$modal","$http","njApply","warn_factor","sell_factor","days",function(a,b,c,d,e,f,g,h,i,j){function k(a){a.start_date=a.startTime?a.startTime:j.startTime(),a.end_date=a.endTime?a.endTime:j.endTime(a.start_date,a.period)}var l=this;$(".footer").addClass("marTop200"),l.currentApply={},a.$on("$routeChangeSuccess",function(){if(0==c.path().indexOf("/apply_detail/")){var b=d.serial_id;g.get({uid:a.data.currentUser._id,serial_id:b},function(a){l.currentApply=a,k(l.currentApply),l.currentApply.isTrial?(l.warn_amount=1800,l.sell_amount=1600):(l.warn_amount=l.currentApply.amount*h,l.sell_amount=l.currentApply.amount*i)})}}),l.alerts=[];var m=function(a,b){l.alerts=[],l.alerts.push({type:a,msg:b})};l.closeAlert=function(a){l.alerts.splice(a,1)},l.closeApply=function(){var a=e.open({templateUrl:"/views/closeApplyModal.html",controller:"CloseApplyModalCtrl",resolve:{}});a.result.then(function(){f.post("/user/apply_close/"+l.currentApply.serialID,{}).success(function(){l.currentApply.status=5,m("success","结算申请已经提交")}).error(function(){m("danger","结算申请提交失败，请稍后重试")})},function(){})}}]),angular.module("userApp").controller("CloseApplyModalCtrl",["$scope","$modalInstance",function(a,b){a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("userApp").controller("UserCapitalCtrl",["$scope","$http","$window","$location","$routeParams","$filter","njOrder","njCard","BankNameList","gbNotifier","njCachedCards",function(a,b,c,d,e,f,g,h,i,j,k){function l(){p=g.query({uid:n.user._id},function(){p=f("orderBy")(p,"createdAt",!0),o=p,m(),n.cards.length>0&&(n.selectedCard=n.cards[0]),n.pay_order_id&&(n.pay_order=_.find(p,{_id:n.pay_order_id}),n.pay_order&&(n.pay_amount=Number(n.pay_order.amount.toFixed(2)),n.pay_order.applySerialID&&(n.pay_for_apply=!0)))})}function m(){n.totalItems=o.length,n.currentPage=1,n.pageChanged()}var n=this;$(".footer").addClass("marTop200"),a.$on("$routeChangeSuccess",function(){if(0===d.path().indexOf("/user_capital")){var a=d.search().category;(!a||a>2)&&(a=1),n.currentCategory=n.categories[a]}}),a.data.menu=2,n.user=a.data.currentUser,k.setUID(n.user._id),n.cards=k.query();var o,p={};n.itemsPerPage=6,n.selected=0,n.tableCss={even:"even"},l(),n.BankNameList=i,n.bankObj=n.BankNameList[0],n.queryItem=function(a){n.selected=a.value,o=p.filter(function(b){return a.value?2===a.value?2===b.dealType||9===b.dealType:2!==b.dealType&&9!==b.dealType:!0}),m()},n.pageChanged=function(){var a=(n.currentPage-1)*n.itemsPerPage,b=a+n.itemsPerPage;b>n.totalItems&&(b=n.totalItems),n.showingItems=o.slice(a,b)},n.queryItems=[{name:"全部",value:0},{name:"资金流入",value:1},{name:"资金流出",value:2}],n.categories=[{file:"/views/withdraw.html",name:"提现",menu:0,value:0},{file:"/views/user_orders.html",name:"资金明细",menu:1,value:1},{file:"/views/my_cards.html",name:"我的银行卡",menu:2,value:2},{file:"/views/add_card.html",name:"我的银行卡",menu:2,value:3}],n.payTypes=[{name:"网银充值",value:0},{name:"支付宝转账",value:1},{name:"银行汇款",value:2}],n.alerts=[];var q=function(a,b){n.alerts=[],n.alerts.push({type:a,msg:b})};n.closeAlert=function(a){n.alerts.splice(a,1)},n.selectCategory=function(a){n.currentCategory=a,d.search().pay_order&&d.search("pay_order",null),2===a.value||0===a.value?n.cards.length>0&&(n.selectedCard=n.cards[0]):2===a.value&&m(),n.finance_password=null,n.withdrawAmount=null,n.alerts=[]},n.selectedCategory=function(){return n.currentCategory.file},n.showAddCard=function(){n.alerts=[],n.currentCategory=n.categories[3]},n.excludeAddCard=function(a){return 3!=a.value},n.addCard=function(){if(!n.bankName)return q("danger","请输入支行名称"),void console.log(n.alerts);var a=/^(\d{16}|\d{19})$/;if(!a.test(n.cardID))return void q("danger","银行卡号格式不正确");var b={userID:n.user._id,bankID:n.bankObj.value,bankName:n.bankName,cardID:n.cardID,userName:n.user.identity.name},c=new h(b);c.$save(function(a){n.alerts=[],q("success","银行卡添加成功!"),n.cards.push(a),n.cardID="",n.bankName="",n.currentCategory=n.categories[2]},function(a){q("success","添加失败 "+a.data.error_msg)})},n.deleteCard=function(a){b.post("/api/delete/card/"+a._id,{card:a}).success(function(){_.remove(n.cards,function(b){return b._id===a._id})}).error(function(){q("danger","删除失败，请稍后再试")})},n.selectCard=function(a){n.selectedCard=a},n.withdraw=function(){if(!n.user.finance.password)return void q("danger","您还未设置提现密码，请先设置提现密码");if(!n.withdrawAmount||n.withdrawAmount<0)return void q("danger","请输入有效的提现金额!");var a=Number(n.withdrawAmount.toFixed(2)),c=Number(n.user.finance.balance.toFixed(2));if(a>c)return void q("danger","余额不足!");if(!n.finance_password)return void q("danger","请输入提现密码!");if(!n.selectedCard)return void q("danger","请选择提现的银行卡!");var d={userID:n.user._id,userMobile:n.user.mobile,dealType:2,amount:a,description:"余额提现",cardInfo:{bank:i[n.selectedCard.bankID].name,bankName:n.selectedCard.bankName,cardID:n.selectedCard.cardID,userName:n.selectedCard.userName}},e={order:d,password:n.finance_password};b.post("/user/withdraw",e).success(function(a){n.user.finance.freeze_capital+=d.amount,n.user.finance.balance-=d.amount,p.unshift(a.order),o=p,m(),n.currentCategory=n.categories[1],q("success","您的提现申请已经提交,我们会尽快处理!")}).error(function(){q("danger","提现申请提交失败,请联系客服!")})},n.showRechargeDetail=function(){n.currentCategory=n.categories[2],n.queryItem(n.queryItems[1])},n.showWithdrawDetail=function(){n.currentCategory=n.categories[1],n.queryItem(n.queryItems[2])}}]),angular.module("userApp").controller("UserHomeCtrl",["$scope","$location","$http","$window","$filter","days","njApply",function(a,b,c,d,e,f,g){function h(){k.totalItems=l.length,k.currentPage=1,k.pageChanged()}function i(){k.ongoing_apply_num=0,m=g.query({uid:k.user._id},function(){angular.forEach(m,function(a){1!=a.status&&3!=a.status&&++k.ongoing_apply_num,j(a)}),m=e("orderBy")(m,"applyAt",!0),l=m,h()}),k.queryItems=[{name:"全部",value:0},{name:"待支付",value:1},{name:"当前操盘",value:2},{name:"已结算",value:3},{name:"审核中",value:4},{name:"结算中",value:5}]}function j(a){a.start_date=a.startTime?a.startTime:f.startTime(),a.end_date=a.endTime?a.endTime:f.endTime(a.start_date,a.period)}var k=this;a.data.menu=1,k.user=a.data.currentUser;var l,m={};k.itemsPerPage=6,k.selected=0,k.tableCss={even:"even"},k.showApplyAccount=null,k.user_total_capital=k.user.finance.balance+k.user.finance.freeze_capital,i(),k.pageChanged=function(){var a=(k.currentPage-1)*k.itemsPerPage,b=a+k.itemsPerPage;b>k.totalItems&&(b=k.totalItems),k.showingItems=l.slice(a,b)},k.queryItem=function(a){k.selected=a.value,l=m.filter(function(b){return a.value?b.status===a.value:!0}),h()},k.manageApply=function(a){1===a.status?d.location.assign("/apply_confirm/"+a.serialID):b.path("/apply_detail/"+a.serialID)},k.toggleDetail=function(a,b){k.showApplyAccount="mouseleave"==a.type?null:b}}]),angular.module("userApp").controller("UserIndexCtrl",["$scope","$window",function(a,b){a.data={menu:1},a.data.currentUser=b.bootstrappedUserObject}]),$(function(){$("#jq_tableBox tr:even td").css("background","#f5f5f5"),$("#jq_tableBox2 tr:even td").css("background","#f5f5f5"),$("#jq_tableBox3 tr:even td").css("background","#f5f5f5"),$("#tableMenu li").click(function(){var a=$(this).index();$(this).addClass("select").siblings().removeClass("select"),$("#tableMain>div").eq(a).show().siblings().hide()})});