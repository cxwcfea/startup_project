!function(){"use strict";angular.module("rechargeApp",["ngResource","ngRoute","ui.bootstrap","commonApp"]),angular.module("rechargeApp").config(["$httpProvider",function(a){a.defaults.headers.get||(a.defaults.headers.get={}),a.defaults.headers.get["Cache-Control"]="no-cache",a.defaults.headers.get.Pragma="no-cache"}]),angular.module("rechargeApp").controller("RechargeCtrl",["$scope","$window","$location","$http","njUser","njOrder","BankNameList",function(a,b,c,d,e,f,g){function h(a){var c=$("#Name")[0].value,d=$("#Version")[0].value,e=$("#Charset")[0].value,f=$("#MsgSender")[0].value,h=$("#OrderNo")[0].value=a._id,j=$("#OrderAmount")[0].value=a.amount.toFixed(2),k=$("#OrderTime")[0].value=moment().format("YYYYMMDDHHmmss"),l=$("#PayType")[0].value,m=$("#PayChannel")[0].value=i.useCredit?20:19,n=$("#InstCode")[0].value=g[i.payBank].instCode,o=$("#PageUrl")[0].value,p=$("#BackUrl")[0].value,q=$("#NotifyUrl")[0].value,r=$("#ProductName")[0].value,s=$("#BuyerIp")[0].value=b.returnCitySN.cip,t=$("#SignType")[0].value,u="JDJhJDA1JHpMRVc3UkJLR202R2hhNHZzZllMYi5",v=c+d+e+f+h+j+k+l+m+n+o+p+q+r+s+t+u,w=SparkMD5.hash(v);w=w.toUpperCase(),$("#SignMsg")[0].value=w,$("#shengPayForm")[0].submit()}var i=this;e.get({id:b.bootstrappedNiujinUserID},function(a){i.user=a;var c=b.location.search,d=c.search("pay_order="),e=null;if(d>-1){e=c.substr(d+10);var g=e.search("&");g>-1&&(e=e.substr(0,g))}e&&(i.pay_order_id=e,i.pay_order=f.get({uid:i.user._id,id:e},function(){i.pay_amount=Number(i.pay_order.amount.toFixed(2)),i.pay_order.applySerialID&&(i.pay_for_apply=!0)}))}),i.currentPayType=0,i.useCredit=!1,i.BankNameList=g,i.bankObj=i.BankNameList[0],i.payBank=0,i.alipayConfirm=!1,i.payTypes=[{name:"网银充值",value:0},{name:"支付宝转账",value:1},{name:"银行汇款",value:2}],i.alerts=[];var j=function(a,b){i.alerts=[],i.alerts.push({type:a,msg:b})};i.closeAlert=function(a){i.alerts.splice(a,1)},i.selectPayType=function(a){i.alerts=[],i.alipayConfirm=!1,i.currentPayType=a.value},i.selectPayBank=function(a){i.payBank=a.value},i.changeCardType=function(a){i.useCredit=a,i.BankNameList=i.useCredit?g.filter(function(a){return a.credit}):g},i.onlinePay=function(){if(!i.pay_amount||i.pay_amount<0)return void j("danger","请输入有效的充值金额");if(i.pay_amount=Number(i.pay_amount.toFixed(2)),!i.pay_amount)return void j("danger","最少充值1分钱");if(i.pay_order)h(i.pay_order);else{var a=new f({uid:i.user._id});a.userID=i.user._id,a.userMobile=i.user.mobile,a.dealType=1,a.amount=i.pay_amount,a.description="网站充值",a.$save(function(a){h(a)},function(){j("danger","服务暂时不可用，请稍后再试")})}},i.aliPay=function(){if(!i.pay_amount||i.pay_amount<0)return void j("danger","请输入有效的充值金额");if(!i.alipay_account)return void j("danger","请输入支付宝账户");if(!i.alipay_name)return void j("danger","请输入支付宝实名认证姓名");if(i.alipayConfirm=!0,i.pay_order)i.pay_order.payType=3,i.pay_order.otherInfo=i.alipay_account,i.pay_order.transID=i.alipay_name,i.pay_order.$save(function(){console.log("order update success")},function(){console.log("order update failed"),j("danger","服务暂时不可用，请稍后再试")});else{var a=new f({uid:i.user._id});a.userID=i.user._id,a.userMobile=i.user.mobile,a.dealType=1,a.amount=Number(i.pay_amount.toFixed(2)),a.description="支付宝转账",a.payType=3,a.status=2,a.otherInfo=i.alipay_account,a.transID=i.alipay_name,a.$save(function(){console.log("order create success")},function(){console.log("order create failed"),j("danger","服务暂时不可用，请稍后再试")})}},i.sendSMSBandInfo=function(){var a="户名：北京小牛普惠科技有限公司，账号：110912609510501，开户行：招商银行股份有限公司北京清华园支行";d.post("/api/send_sms",{sms_content:a}).success(function(){j("success","短信发送成功")}).error(function(){j("danger","短信发送失败，请稍后重试")})}}]),angular.module("rechargeApp").controller("RechargeCtrl2",["$scope","$window","$location","$http","njUser","njOrder","BankNameList",function(a,b,c,d,e,f,g){function h(a){j.user.lastPayBank=j.payBank,d.post("/api/user/"+j.user._id,j.user).success(function(a){j.user=a,console.log("lastPayBank updated")}).error(function(){console.log("lastPayBank update failed")});var c=$("#Name")[0].value,e=$("#Version")[0].value,f=$("#Charset")[0].value,h=$("#MsgSender")[0].value,i=$("#OrderNo")[0].value=a._id,k=$("#OrderAmount")[0].value=a.amount.toFixed(2),l=$("#OrderTime")[0].value=moment().format("YYYYMMDDHHmmss"),m=$("#PayType")[0].value,n=$("#PayChannel")[0].value=j.useCredit?20:19,o=$("#InstCode")[0].value=g[j.payBank].instCode,p=$("#PageUrl")[0].value,q=$("#BackUrl")[0].value,r=$("#NotifyUrl")[0].value,s=$("#ProductName")[0].value,t=$("#BuyerIp")[0].value=b.returnCitySN.cip,u=$("#SignType")[0].value,v="JDJhJDA1JHpMRVc3UkJLR202R2hhNHZzZllMYi5",w=c+e+f+h+i+k+l+m+n+o+p+q+r+s+t+u+v,x=SparkMD5.hash(w);x=x.toUpperCase(),$("#SignMsg")[0].value=x,$("#shengPayForm")[0].submit()}function i(){j.pay_amount=j.pay_order.amount,j.useBalance&&(j.pay_amount-=j.user.finance.balance)}var j=this;j.user=b.bootstrappedUserObject,j.pay_order=b.bootstrappedOrderObject,j.currentPayType=0,j.useCredit=!1,j.BankNameList=g,j.useBalance=!1,j.user.finance.balance>0&&(j.useBalance=!0,i()),j.BankNameLists=[];for(var k=[],l=0;l<g.length;++l)4===k.length&&(j.BankNameLists.push(k),k=[]),k.push(g[l]);k.length>0&&j.BankNameLists.push(k),j.btnName="更换银行",j.showAlipayWindow=!1,j.showPayConfirm=!1,j.showBankTransWindow=!1,j.paying=!1,j.bankObj=j.BankNameList[0],j.payBank=-1,j.alipayConfirm=!1,j.user.lastPayBank>=0?j.payBank=j.user.lastPayBank:(j.btnName="收起",$(".jq_rec2_yhBox").toggleClass("rec2_yhBoxSelected"),$(".jq_rec2_yhkList").slideToggle(200)),j.payTypes=[{name:"网银充值",value:0},{name:"支付宝转账",value:1},{name:"银行汇款",value:2}],j.alerts=[],i();var m=function(a,b){j.alerts=[],j.alerts.push({type:a,msg:b})};j.closeAlert=function(a){j.alerts.splice(a,1)},j.selectPayType=function(a){j.alerts=[],j.alipayConfirm=!1,j.currentPayType=a,2===j.currentPayType&&(j.showBankTransWindow=!0),1===j.currentPayType&&(j.showAlipayWindow=!0)},j.selectPayBank=function(a){j.payBank=a.value,$(".jq_rec2_yhBox").toggleClass("rec2_yhBoxSelected"),$(".jq_rec2_yhkList").slideToggle(200),j.btnName="更换银行"},j.changeBtnName=function(){j.btnName="更换银行"===j.btnName?"收起":"更换银行"},j.changeCardType=function(a){j.useCredit=a,j.BankNameList=j.useCredit?g.filter(function(a){return a.credit}):g},j.sendSMSBankInfo=function(){var a="户名：北京小牛普惠科技有限公司，账号：110912609510501，开户行：招商银行股份有限公司北京清华园支行";d.post("/api/send_sms",{sms_content:a}).success(function(){m("success","短信发送成功")}).error(function(){m("danger","短信发送失败，请稍后重试")})},j.balanceChecked=function(){i()},j.gotoPay=function(){return-1===j.payBank?void m("danger","请先选择付款银行"):void(j.showPayConfirm=!0)},j.onlinePay=function(){j.pay_amount=Number(j.pay_amount.toFixed(2)),j.pay_order.amount=j.pay_amount,j.paying=!0,d.post("/api/user/"+j.user._id+"/orders/"+j.pay_order._id,j.pay_order).success(function(){console.log("order update success"),h(j.pay_order)}).error(function(){console.log("order update failed"),m("danger","服务暂时不可用，请稍后再试")})},j.closeOtherWindow=function(){j.showAlipayWindow=!1,j.showBankTransWindow=!1,j.alipayConfirm=!1,j.alerts=[]},j.aliPay=function(){return j.alipay_account?j.alipay_name?(j.alipayConfirm=!0,j.pay_amount=Number(j.pay_amount.toFixed(2)),j.pay_order.amount=j.pay_amount,j.pay_order.payType=3,j.pay_order.otherInfo=j.alipay_account,j.pay_order.transID=j.alipay_name,void d.post("/api/user/"+j.user._id+"/orders/"+j.pay_order._id,j.pay_order).success(function(){console.log("order update success")}).error(function(){console.log("order update failed"),m("danger","服务暂时不可用，请稍后再试")})):void m("danger","请输入支付宝实名认证姓名"):void m("danger","请输入支付宝账户")}}])}();