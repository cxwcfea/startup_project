!function(){"use strict";angular.module("rechargeApp",["ngResource","ngRoute","ui.bootstrap","commonApp"]),angular.module("rechargeApp").controller("RechargeCtrl",["$scope","$window","$location","$http","njUser","njOrder","BankNameList",function(a,b,c,d,e,f,g){function h(a){var c=$("#Name")[0].value,d=$("#Version")[0].value,e=$("#Charset")[0].value,f=$("#MsgSender")[0].value,h=$("#OrderNo")[0].value=a._id,j=$("#OrderAmount")[0].value=a.amount.toFixed(2),k=$("#OrderTime")[0].value=moment().format("YYYYMMDDHHmmss"),l=$("#PayType")[0].value,m=$("#PayChannel")[0].value=i.useCredit?20:19,n=$("#InstCode")[0].value=g[i.payBank].instCode,o=$("#PageUrl")[0].value,p=$("#BackUrl")[0].value,q=$("#NotifyUrl")[0].value,r=$("#ProductName")[0].value,s=$("#BuyerIp")[0].value=b.returnCitySN.cip,t=$("#SignType")[0].value,u="JDJhJDA1JHpMRVc3UkJLR202R2hhNHZzZllMYi5",v=c+d+e+f+h+j+k+l+m+n+o+p+q+r+s+t+u,w=SparkMD5.hash(v);w=w.toUpperCase(),$("#SignMsg")[0].value=w,$("#shengPayForm")[0].submit()}var i=this;e.get({id:b.bootstrappedNiujinUserID},function(a){i.user=a;var c=b.location.search,d=c.search("pay_order="),e=null;if(d>-1){e=c.substr(d+10);var g=e.search("&");g>-1&&(e=e.substr(0,g))}e&&(i.pay_order_id=e,i.pay_order=f.get({uid:i.user._id,id:e},function(){i.pay_amount=Number(i.pay_order.amount.toFixed(2)),i.pay_order.applySerialID&&(i.pay_for_apply=!0)}))}),i.currentPayType=0,i.useCredit=!1,i.BankNameList=g,i.bankObj=i.BankNameList[0],i.payBank=0,i.alipayConfirm=!1,i.payTypes=[{name:"网银充值",value:0},{name:"支付宝转账",value:1},{name:"银行汇款",value:2}],i.alerts=[];var j=function(a,b){i.alerts=[],i.alerts.push({type:a,msg:b})};i.closeAlert=function(a){i.alerts.splice(a,1)},i.selectPayType=function(a){i.alerts=[],i.alipayConfirm=!1,i.currentPayType=a.value},i.selectPayBank=function(a){i.payBank=a.value},i.changeCardType=function(a){i.useCredit=a,i.BankNameList=i.useCredit?g.filter(function(a){return a.credit}):g},i.onlinePay=function(){if(!i.pay_amount||i.pay_amount<0)return void j("danger","请输入有效的充值金额");if(i.pay_amount=Number(i.pay_amount.toFixed(2)),!i.pay_amount)return void j("danger","最少充值1分钱");if(i.pay_order)h(i.pay_order);else{var a=new f({uid:i.user._id});a.userID=i.user._id,a.userMobile=i.user.mobile,a.dealType=1,a.amount=i.pay_amount,a.description="网站充值",a.$save(function(a){h(a)},function(){j("danger","服务暂时不可用，请稍后再试")})}},i.aliPay=function(){if(!i.pay_amount||i.pay_amount<0)return void j("danger","请输入有效的充值金额");if(!i.alipay_account)return void j("danger","请输入支付宝账户");if(!i.alipay_name)return void j("danger","请输入支付宝实名认证姓名");if(i.alipayConfirm=!0,i.pay_order)i.pay_order.payType=3,i.pay_order.otherInfo=i.alipay_account,i.pay_order.transID=i.alipay_name,i.pay_order.$save(function(){console.log("order update success")},function(){console.log("order update failed"),j("danger","服务暂时不可用，请稍后再试")});else{var a=new f({uid:i.user._id});a.userID=i.user._id,a.userMobile=i.user.mobile,a.dealType=1,a.amount=Number(i.pay_amount.toFixed(2)),a.description="支付宝转账",a.payType=3,a.status=2,a.otherInfo=i.alipay_account,a.transID=i.alipay_name,a.$save(function(){console.log("order create success")},function(){console.log("order create failed"),j("danger","服务暂时不可用，请稍后再试")})}},i.sendSMSBandInfo=function(){var a="户名：北京小牛普惠科技有限公司，账号：110912609510501，开户行：招商银行股份有限公司北京清华园支行";d.post("/api/send_sms",{sms_content:a}).success(function(){j("success","短信发送成功")}).error(function(){j("danger","短信发送失败，请稍后重试")})}}]),angular.module("rechargeApp").controller("RechargeCtrl2",["$scope","$window","$location","$http","njUser","njOrder","BankNameList",function(a,b,c,d,e,f,g){function h(a){k.user.lastPayBank=k.payBank,d.post("/api/user/"+k.user._id,k.user).success(function(a){k.user=a,console.log("lastPayBank updated")}).error(function(){console.log("lastPayBank update failed")});var c=$("#Name")[0].value,e=$("#Version")[0].value,f=$("#Charset")[0].value,h=$("#MsgSender")[0].value,i=$("#OrderNo")[0].value=a._id,j=$("#OrderAmount")[0].value=a.amount.toFixed(2),l=$("#OrderTime")[0].value=moment().format("YYYYMMDDHHmmss"),m=$("#PayType")[0].value,n=$("#PayChannel")[0].value=k.useCredit?20:19,o=$("#InstCode")[0].value=g[k.payBank].instCode,p=$("#PageUrl")[0].value,q=$("#BackUrl")[0].value,r=$("#NotifyUrl")[0].value,s=$("#ProductName")[0].value,t=$("#BuyerIp")[0].value=b.returnCitySN.cip,u=$("#SignType")[0].value,v="JDJhJDA1JHpMRVc3UkJLR202R2hhNHZzZllMYi5",w=c+e+f+h+i+j+l+m+n+o+p+q+r+s+t+u+v,x=SparkMD5.hash(w);x=x.toUpperCase(),$("#SignMsg")[0].value=x,$("#shengPayForm")[0].submit()}function i(){return k.alipay_account?k.alipay_name?(k.alipayConfirm=!0,k.showNextBtn=!1,k.pay_amount=Number(k.pay_amount.toFixed(2)),k.pay_order.amount=k.pay_amount,k.pay_order.payType=3,k.pay_order.otherInfo=k.alipay_account,k.pay_order.transID=k.alipay_name,void d.post("/api/user/"+k.user._id+"/orders/"+k.pay_order._id,k.pay_order).success(function(){console.log("order update success")}).error(function(){console.log("order update failed"),n("danger","服务暂时不可用，请稍后再试")})):void n("danger","请输入支付宝实名认证姓名"):void n("danger","请输入支付宝账户")}function j(){k.pay_amount=k.pay_order.amount,k.useBalance&&(k.pay_amount-=k.user.finance.balance)}var k=this;k.user=b.bootstrappedUserObject,k.pay_order=b.bootstrappedOrderObject,k.currentPayType=0,k.useCredit=!1,k.BankNameList=g,k.useBalance=!1,k.BankNameLists=[];for(var l=[],m=0;m<g.length;++m)4===l.length&&(k.BankNameLists.push(l),l=[]),l.push(g[m]);l.length>0&&k.BankNameLists.push(l),k.showPayConfirm=!1,k.showNextBtn=!0,k.paying=!1,k.bankObj=k.BankNameList[0],k.payBank=-1,k.alipayConfirm=!1,k.user.lastPayBank>=0?k.payBank=k.user.lastPayBank:($(".jq_rec2_yhBox").toggleClass("rec2_yhBoxSelected"),$(".jq_rec2_yhkList").slideToggle(200)),k.payTypes=[{name:"网银充值",value:0},{name:"支付宝转账",value:1},{name:"银行汇款",value:2}],k.alerts=[],j();var n=function(a,b){k.alerts=[],k.alerts.push({type:a,msg:b})};k.closeAlert=function(a){k.alerts.splice(a,1)},k.selectPayType=function(a){k.alerts=[],k.alipayConfirm=!1,k.currentPayType=a,k.showNextBtn=2===k.currentPayType?!1:!0},k.selectPayBank=function(a){k.payBank=a.value},k.changeCardType=function(a){k.useCredit=a,k.BankNameList=k.useCredit?g.filter(function(a){return a.credit}):g},k.sendSMSBankInfo=function(){var a="户名：北京小牛普惠科技有限公司，账号：110912609510501，开户行：招商银行股份有限公司北京清华园支行";d.post("/api/send_sms",{sms_content:a}).success(function(){n("success","短信发送成功")}).error(function(){n("danger","短信发送失败，请稍后重试")})},k.balanceChecked=function(){console.log(k.useBalance),j()},k.gotoPay=function(){if(0===k.currentPayType){if(-1===k.payBank)return void n("danger","请先选择付款银行");k.showPayConfirm=!0}else 1===k.currentPayType&&i()},k.onlinePay=function(){k.pay_amount=Number(k.pay_amount.toFixed(2)),k.pay_order.amount=k.pay_amount,k.paying=!0,d.post("/api/user/"+k.user._id+"/orders/"+k.pay_order._id,k.pay_order).success(function(){console.log("order update success"),h(k.pay_order)}).error(function(){console.log("order update failed"),n("danger","服务暂时不可用，请稍后再试")})}}])}();