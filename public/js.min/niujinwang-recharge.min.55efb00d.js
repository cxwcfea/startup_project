!function(){"use strict";angular.module("rechargeApp",["ngResource","ngRoute","ui.bootstrap","commonApp"]),angular.module("rechargeApp").controller("RechargeCtrl",["$scope","$window","$location","$http","njUser","njOrder","BankNameList",function(a,b,c,d,e,f,g){function h(a){var c=$("#Name")[0].value,d=$("#Version")[0].value,e=$("#Charset")[0].value,f=$("#MsgSender")[0].value,h=$("#OrderNo")[0].value=a._id,j=$("#OrderAmount")[0].value=a.amount.toFixed(2),k=$("#OrderTime")[0].value=moment().format("YYYYMMDDHHmmss"),l=$("#PayType")[0].value,m=$("#PayChannel")[0].value=i.useCredit?20:19,n=$("#InstCode")[0].value=g[i.payBank].instCode,o=$("#PageUrl")[0].value,p=$("#BackUrl")[0].value,q=$("#NotifyUrl")[0].value,r=$("#ProductName")[0].value,s=$("#BuyerIp")[0].value=b.returnCitySN.cip,t=$("#SignType")[0].value,u="shengfutongSHENGFUTONGtest",v=c+d+e+f+h+j+k+l+m+n+o+p+q+r+s+t+u,w=SparkMD5.hash(v);w=w.toUpperCase(),$("#SignMsg")[0].value=w,$("#shengPayForm")[0].submit()}var i=this;e.get({id:b.bootstrappedNiujinUserID},function(a){i.user=a;var c=b.location.search,d=c.search("pay_order="),e=null;if(d>-1){e=c.substr(d+10);var g=e.search("&");g>-1&&(e=e.substr(0,g))}e&&(i.pay_order_id=e,i.pay_order=f.get({uid:i.user._id,id:e},function(){i.pay_amount=Number(i.pay_order.amount.toFixed(2)),i.pay_order.applySerialID&&(i.pay_for_apply=!0)}))}),i.currentPayType=1,i.useCredit=!1,i.BankNameList=g,i.bankObj=i.BankNameList[0],i.payBank=0,i.alipayConfirm=!1,i.payTypes=[{name:"网银充值",value:0},{name:"支付宝转账",value:1},{name:"银行汇款",value:2}],i.alerts=[];var j=function(a,b){i.alerts=[],i.alerts.push({type:a,msg:b})};i.closeAlert=function(a){i.alerts.splice(a,1)},i.selectPayType=function(a){i.alerts=[],i.alipayConfirm=!1,0==a.value&&(j("danger","抱歉，网银充值暂不可用"),a=i.payTypes[1]),i.currentPayType=a.value},i.selectPayBank=function(a){i.payBank=a.value},i.changeCardType=function(a){i.useCredit=a,i.BankNameList=i.useCredit?g.filter(function(a){return a.credit}):g},i.onlinePay=function(){if(!i.pay_amount||i.pay_amount<0)return void j("danger","请输入有效的充值金额");if(i.pay_amount=Number(i.pay_amount.toFixed(2)),!i.pay_amount)return void j("danger","最少充值1分钱");if(i.pay_order)h(i.pay_order);else{var a=new f({uid:i.user._id});a.userID=i.user._id,a.userMobile=i.user.mobile,a.dealType=1,a.amount=i.pay_amount,a.description="网站充值",a.$save(function(a){h(a)},function(){j("danger","服务暂时不可用，请稍后再试")})}},i.aliPay=function(){if(!i.pay_amount||i.pay_amount<0)return void j("danger","请输入有效的充值金额");if(!i.alipay_account)return void j("danger","请输入支付宝账户");if(!i.alipay_name)return void j("danger","请输入支付宝实名认证姓名");if(i.alipayConfirm=!0,i.pay_order)i.pay_order.payType=3,i.pay_order.otherInfo=i.alipay_account,i.pay_order.transID=i.alipay_name,i.pay_order.$save(function(){console.log("order update success")},function(){console.log("order update failed"),j("danger","服务暂时不可用，请稍后再试")});else{var a=new f({uid:i.user._id});a.userID=i.user._id,a.userMobile=i.user.mobile,a.dealType=1,a.amount=Number(i.pay_amount.toFixed(2)),a.description="支付宝转账",a.payType=3,a.status=2,a.otherInfo=i.alipay_account,a.transID=i.alipay_name,a.$save(function(){console.log("order create success")},function(){console.log("order create failed"),j("danger","服务暂时不可用，请稍后再试")})}},i.sendSMSBandInfo=function(){var a="户名：北京小牛普惠科技有限公司，账号：110912609510501，开户行：招商银行股份有限公司北京清华园支行";d.post("/api/send_sms",{sms_content:a}).success(function(){j("success","短信发送成功")}).error(function(){j("danger","短信发送失败，请稍后重试")})}}])}();