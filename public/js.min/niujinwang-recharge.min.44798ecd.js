!function(){"use strict";angular.module("rechargeApp",["ngResource","ngRoute","ui.bootstrap","commonApp"]),angular.module("rechargeApp").config(["$httpProvider",function(a){a.defaults.headers.get||(a.defaults.headers.get={}),a.defaults.headers.get["Cache-Control"]="no-cache",a.defaults.headers.get.Pragma="no-cache"}]),angular.module("rechargeApp").controller("RechargeCtrl",["$scope","$window","$location","$http","njUser","njOrder","BankNameList",function(a,b,c,d,e,f,g){function h(a){j.user.lastPayBank=j.payBank,d.post("/api/user/"+j.user._id,j.user).success(function(a){j.user=a,console.log("lastPayBank updated")}).error(function(){console.log("lastPayBank update failed")});$("#OrderNo")[0].value=a._id,$("#OrderAmount")[0].value=a.amount.toFixed(2),$("#InstCode")[0].value=g[j.payBank].instCode,$("#BuyerIp")[0].value=b.returnCitySN.cip;$("#shengPayForm")[0].submit()}function i(){j.pay_amount=j.pay_order.amount,j.useBalance&&(j.pay_amount-=j.user.finance.balance)}var j=this;j.user=b.bootstrappedUserObject,j.pay_order=b.bootstrappedOrderObject,j.currentPayType=0,j.useCredit=!1,j.BankNameList=g,j.useBalance=!1,j.user.finance.balance>0&&(j.useBalance=!0,i()),j.BankNameLists=[];for(var k=[],l=0;l<g.length;++l)4===k.length&&(j.BankNameLists.push(k),k=[]),k.push(g[l]);k.length>0&&j.BankNameLists.push(k),j.btnName="更换银行",j.showAlipayWindow=!1,j.showPayConfirm=!1,j.showBankTransWindow=!1,j.paying=!1,j.bankObj=j.BankNameList[0],j.payBank=-1,j.alipayConfirm=!1,j.user.lastPayBank>=0?j.payBank=j.user.lastPayBank:(j.btnName="收起",$(".jq_rec2_yhBox").toggleClass("rec2_yhBoxSelected"),$(".jq_rec2_yhkList").slideToggle(200)),j.smsSend=!1,j.alipayAccountConfirm=!1,j.user.profile.alipay_account&&(j.alipayAccountConfirm=!0,j.alipay_account=j.user.profile.alipay_account,j.alipay_name=j.user.profile.alipay_name),j.payTypes=[{name:"网银充值",value:0},{name:"支付宝转账",value:1},{name:"银行汇款",value:2}],j.alerts=[],i();var m=function(a,b){j.alerts=[],j.alerts.push({type:a,msg:b})};j.closeAlert=function(a){j.alerts.splice(a,1)},j.selectPayType=function(a){j.alerts=[],j.alipayConfirm=!1,j.currentPayType=a,2===j.currentPayType&&(j.showBankTransWindow=!0),1===j.currentPayType&&(j.showAlipayWindow=!0)},j.selectPayBank=function(a){j.payBank=a.value,$(".jq_rec2_yhBox").toggleClass("rec2_yhBoxSelected"),$(".jq_rec2_yhkList").slideToggle(200),j.btnName="更换银行"},j.changeBtnName=function(){j.btnName="更换银行"===j.btnName?"收起":"更换银行"},j.changeCardType=function(a){j.useCredit=a,j.BankNameList=j.useCredit?g.filter(function(a){return a.credit}):g},j.sendSMSBankInfo=function(){if(m("success","信息已发送，请勿重复点击"),!j.smsSend){j.smsSend=!0;var a="户名：北京小牛普惠科技有限公司，账号：110912609510501，开户行：招商银行股份有限公司北京清华园支行";d.post("/api/send_sms",{sms_content:a}).success(function(){m("success","短信发送成功")}).error(function(){m("danger","短信发送失败，请稍后重试")})}},j.balanceChecked=function(){i()},j.gotoPay=function(){return-1===j.payBank?void m("danger","请先选择付款银行"):void(j.showPayConfirm=!0)},j.onlinePay=function(){j.pay_amount=Number(j.pay_amount.toFixed(2)),j.pay_order.amount=j.pay_amount,j.paying=!0,d.post("/api/user/"+j.user._id+"/orders/"+j.pay_order._id,j.pay_order).success(function(){console.log("order update success"),h(j.pay_order)}).error(function(){console.log("order update failed"),m("danger","服务暂时不可用，请稍后再试")})},j.closeOtherWindow=function(){j.smsSend=!1,j.showAlipayWindow=!1,j.showBankTransWindow=!1,j.alipayConfirm=!1,j.alerts=[]},j.aliPay=function(){return j.alipay_account?j.alipay_name?(j.alipayConfirm=!0,j.pay_amount=Number(j.pay_amount.toFixed(2)),j.pay_order.amount=j.pay_amount,j.pay_order.payType=3,j.pay_order.otherInfo=j.alipay_account,j.pay_order.transID=j.alipay_name,void d.post("/api/user/"+j.user._id+"/orders/"+j.pay_order._id,j.pay_order).success(function(){console.log("order update success")}).error(function(){j.alipayConfirm=!1,403===response.status?m("danger",response.data):(console.log("order update failed"),m("danger","服务暂时不可用，请稍后再试"))})):void m("danger","请输入支付宝实名认证姓名"):void m("danger","请输入支付宝账户")}}])}();