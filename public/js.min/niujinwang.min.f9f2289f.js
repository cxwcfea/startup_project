"use strict";angular.module("commonApp",[]),angular.module("commonApp").value("gbToastr",toastr),angular.module("commonApp").factory("gbNotifier",["gbToastr",function(a){return{notify:function(b){a.success(b)},error:function(b){a.error(b)}}}]),$(document).ready(function(){moment.locale("zh-cn"),$(".verify-code-btn").click(function(){var a=$(this),b=$("#mobile")[0].value;if(!b||0!==b.search(/1[3|5|7|8|][0-9]{9}$/))return void $("#correct-mobile-alert").modal({});a.button("loading"),setTimeout(function(){a.button("reset")},6e4);var c={mobile:b.trim()};$.get("/api/send_sms_verify_code",c,function(a){console.log(a)})}),$("#go-to-pay").on("click",function(a){a.preventDefault(),window.open("/third_party_pay"),$("#pay-confirm").modal({relatedTarget:this,onConfirm:function(){var a=$("#pay_amount")[0].value;$.post("/api/users/update_balance",{pay_amount:a},function(a){if(a.success){var b=$("#total_amount")[0].value,c=$("#apply_id")[0].value;$.post("/api/users/pay_by_balance",{pay_amount:b,apply_id:c},function(a){window.location.replace(a.success?"/thank_you_for_pay":"/failed_to_pay")})}else window.location.replace("/failed_to_pay")})},onCancel:function(){window.location.replace("/support_contact")}})}),$("#go-to-use-balance").on("click",function(a){a.preventDefault();var b=$("form").serialize();$.post("/api/users/pay_by_balance",b,function(a){window.location.replace(a.success?"/thank_you_for_pay":"/failed_to_pay")})})}),angular.module("myApp").factory("gbIdentity",["$window",function(a){var b;return a.bootstrappedUserObject&&(b={},angular.extend(b,a.bootstrappedUserObject)),{currentUser:b}}]),angular.module("applyApp",[]),angular.module("applyApp").controller("ApplyController",["$http","$location","$window",function(a,b,c){function d(){h.summary.warnValue=h.summary.amount*i,h.summary.sellValue=h.summary.amount*j,h.summary.deposit=h.summary.amount*k;var a=h.summary.amount/1e4*l*h.summary.day;h.summary.charge=a,h.summary.total=h.summary.deposit+a}function e(){angular.forEach(h.amountList,function(a){a.select=!1})}function f(){angular.forEach(h.dayList,function(a){a.select=!1})}function g(){h.summary.amount=h.otherAmount>=2e3?Math.floor(h.otherAmount):h.otherAmount=2e3,d()}var h=this,i=.93,j=.95,k=.1,l=18.8;h.agree=!0,h.showOtherAmount=!1,h.otherAmount=2e3,h.summary={day:5,amount:5e4},d(),h.amountList=[{name:"2000元",value:"2000"},{name:"1万",value:"10000"},{name:"3万",value:"30000"},{name:"5万",value:"50000",select:!0},{name:"10万",value:"100000"},{name:"30万",value:"300000"}],h.dayList=[{value:"2"},{value:"5",select:!0},{value:"8"},{value:"10"}],h.selectAmount=function(a){e(),h.showOtherAmount=!1,h.otherAmount=0,a.select=!0,h.summary.amount=a.value,d()},h.selectDay=function(a){f(),a.select=!0,h.summary.day=a.value,d()},h.toggleOtherAmount=function(){e(),h.showOtherAmount=!h.showOtherAmount,g()},h.finishOtherAmount=function(){g()},h.submitApply=function(){a.post("/apply",h.summary).then(function(a){a.data.success?c.location.href="/apply_confirm/"+a.data.apply_id:"not authenticate"===a.data.reason&&(c.location.href="/login")})}}]),angular.module("myApp").controller("UserApplyListController",["gbIdentity","$http","gbNotifier","$location","gbApply","$window",function(a,b,c,d,e,f){function g(){j.totalItems=k.length,j.currentPage=1,j.pageChanged()}function h(){l=e.query({uid:j.user._id},function(){angular.forEach(l,function(a){i(a)}),k=l,g()}),j.queryItems=[{name:"全部",value:0},{name:"待支付",value:1},{name:"当前操盘",value:2},{name:"已结算",value:3},{name:"审核中",value:4}]}function i(a){var b=moment(a.applyAt);switch(a.start_date=b.format("YYYY-MM-DD HH:mm"),a.end_date=b.add(a.period,"days").format("YYYY-MM-DD HH:mm"),a.status){case 1:a.status_str="待支付";break;case 2:a.status_str="操盘中";break;case 3:a.status_str="已结算";break;case 4:a.status_str="审核中";break;case 5:a.status_str="失败"}}var j=this;j.user=a.currentUser;var k,l={};j.itemsPerPage=15,h(),j.queryItem=function(a){k=l.filter(function(b){return a.value?b.status===a.value:!0}),g()},j.pageChanged=function(){var a=(j.currentPage-1)*j.itemsPerPage,b=a+j.itemsPerPage;b>j.totalItems&&(b=j.totalItems),j.showingItems=k.slice(a,b)},j.manageApply=function(a){f.location.assign(1===a.status?"/apply_confirm/"+a.serialID:"/apply_detail/"+a.serialID)}}]),angular.module("myApp").controller("UserEmailController",["gbIdentity","$http","gbNotifier","$location",function(a,b,c){var d=this;d.user=a.currentUser,d.verifyEmail=function(){console.log("verify email"),b.post("/user/verify_email",{email:d.user.profile.email}).then(function(a){a.data.success?c.notify("email send success"):c.error("email send fail "+a.data.reason)})}}]),angular.module("myApp").controller("UserIdentityController",["gbIdentity","$http","gbNotifier","$location",function(a,b,c,d){var e=this;e.user=a.currentUser,e.submitRequest=function(){b.post("/api/users/"+e.user._id,{identity:e.user.identity}).then(function(a){a.data.success?(c.notify("实名认证成功"),d.path("/user/security")):c.error("实名认证失败")})}}]),angular.module("myApp").controller("UserIndexController",["$location","$http",function(a,b){var c=this;c.gotoRoot=function(){window.location="/"},c.signout=function(){b.post("/logout",{logout:!0}).then(function(){window.location="/"})}}]),angular.module("myApp").controller("UserMainController",["gbIdentity",function(a){var b=this;b.user=a.currentUser,b.displayName=function(){return b.user.profile.name?b.user.profile.name:b.user.mobile},b.registerDate=function(){return moment(b.user.registerAt).format("ll")}}]),angular.module("myApp").controller("UserOrderController",["gbIdentity",function(a){function b(){d=e.user.orders,c(),e.queryItems=[{name:"全部",value:0},{name:"充值",value:1},{name:"提现",value:2}]}function c(){e.totalItems=d.length,e.currentPage=1,e.pageChanged()}var d,e=this;e.user=a.currentUser,e.itemsPerPage=15,e.queryItem=function(a){d=e.user.orders.filter(function(b){return 1===a.value?"充值"===b.dealType:2===a.value?"提现"===b.dealType:!0}),c()},e.pageChanged=function(){var a=(e.currentPage-1)*e.itemsPerPage,b=a+e.itemsPerPage;b>e.totalItems&&(b=e.totalItems),e.showingItems=d.slice(a,b)},e.formatDate=function(a){return moment(a).format("YYYY-MM-DD HH:mm")},b()}]),angular.module("myApp").controller("UserPayController",["gbIdentity","$http","gbNotifier","$location","gbOrder",function(a,b,c,d,e){var f=this;f.user=a.currentUser,f.submitRequest=function(){if(!f.payAmount||f.payAmount<=0)return void c.error("无效的充值金额");var a={userID:f.user._id,dealType:"充值",amount:f.payAmount,description:"10倍配资"},d=new e(a);d.$save().then(function(a){c.notify("订单提交成功"),a.order.status=a.order.status?"交易成功":"交易失败",f.user.orders.push(a.order)},function(a){c.error("订单提交失败 "+a.data.reason)});var g=f.user.finance.balance+f.payAmount;b.post("/api/users/"+f.user._id,{finance:{balance:g}}).then(function(a){a.data.success?(f.user.finance.balance=g,c.notify("充值成功")):c.error("充值失败:"+a.data.reason)})}}]),angular.module("myApp").controller("UserProfileController",["gbIdentity","gbNotifier","$http",function(a,b,c){var d=this;d.user=a.currentUser,d.updateUserProfile=function(){c.post("/api/users/"+d.user._id,{profile:d.user.profile}).then(function(a){a.data.success?b.notify("个人信息更新成功"):b.error("个人信息更新失败")})}}]),angular.module("myApp").controller("UserResetPasswordController",["gbIdentity","$http","gbNotifier","$location",function(a,b,c,d){var e=this;e.user=a.currentUser,e.submitRequest=function(){return e.new_pass!==e.confirm_pass?void c.error("两次输入的密码不同"):void b.post("/user/change_pass",{old_password:e.old_pass,password:e.new_pass,confirm_password:e.confirm_pass}).then(function(a){a.data.success?(c.notify("密码设置成功"),d.path("/security")):c.error("密码设置失败："+a.data.reason)})},e.changeFinancePass=function(){return e.new_finance_pass!==e.confirm_finance_pass?void c.error("两次输入的密码不同"):void b.post("/user/change_finance_pass",{password:e.login_pass,new_password:e.new_finance_pass,confirm_password:e.confirm_finance_pass}).then(function(a){a.data.success?(e.user.finance.password=a.data.result,c.notify("密码设置成功"),d.path("/security")):c.error(a.data.reason)})}}]),angular.module("myApp").controller("UserSecurityController",["gbIdentity",function(a){var b=this;b.user=a.currentUser,b.securityObjects=[{"class":"am-icon-user-secret am-icon-lg",title:"实名认证",status:b.user.identity.id?"已认证":"未认证",url:"/user#/identity",action:"去认证",show:b.user.identity.id?!1:!0},{"class":"am-icon-mobile am-icon-lg",title:"绑定手机",status:"已认证",url:"#",action:"修改",show:!1},{"class":"am-icon-envelope am-icon-lg",title:"验证邮箱",status:b.user.profile.email_verified?"已验证":"未验证",url:"/user#/verify_email",action:"去验证",show:b.user.profile.email_verified?!1:!0},{"class":"am-icon-key am-icon-lg",title:"登录密码",status:"已设置",url:"/user#/change_pass",action:"修改",show:!0},{"class":"am-icon-money am-icon-lg",title:"提现密码",status:b.user.finance.password?"已设置":"未设置",url:"/user#/change_finance_pass",action:b.user.finance.password?"修改":"设置",show:!0}]}]),angular.module("myApp").controller("UserWithdrawController",["gbIdentity","gbNotifier","$location","gbCard","gbCachedCards","gbOrder","$http",function(a,b,c,d,e,f,g){var h=this;h.user=a.currentUser,h.cards=[],h.card={},h.card.userID=h.user._id,h.user.identity.name&&(h.card.userName=h.user.identity.name),e.setUID(h.user._id),h.cards=e.query(),h.selectCard=function(a){h.selected=a},h.isSelected=function(a){return h.selected===a},h.addCard=function(){console.log();var a=new d(h.card);a.$save().then(function(){b.notify("添加成功"),h.cards.push(h.card)},function(a){b.error("添加失败 "+a.data.reason)})},h.withdraw=function(){h.selected?h.amount<=0||h.amount>h.user.finance.balance?b.error("无效的提现金额："+h.amount):g.post("/user/verify_finance_password",{password:h.password}).then(function(a){if(a.data.success){var c={userID:h.user._id,dealType:"提现",amount:h.amount,description:"10倍配资"},d=new f(c);d.$save().then(function(a){b.notify("提现申请提交成功"),a.order.status=a.order.status?"交易成功":"处理中",h.user.orders.push(a.order)},function(a){b.error("提现申请提交失败 "+a.data.reason)}),b.notify("提现 "+h.amount)}else b.error("提现申请提交失败 "+a.data.reason)}):b.error("请选择要提现的银行卡")},h.setPassword=function(){c.path("/change_finance_pass")}}]),angular.module("myApp").factory("gbApply",["$resource",function(a){var b=a("/api/applies/:uid/apply/:aid",{userID:"@uid",applyID:"@aid"});return b}]),angular.module("myApp").factory("gbCard",["$resource",function(a){var b=a("/api/cards/:uid",{userID:"@uid"});return b}]),angular.module("myApp").factory("gbOrder",["$resource",function(a){var b=a("/api/orders/:id",{_id:"@id"},{update:{method:"PUT",isArray:!1}});return b}]),angular.module("myApp").factory("gbCachedCards",["gbCard",function(a){var b,c;return{setUID:function(a){c=a},query:function(){return b||(b=a.query({uid:c})),b}}}]),angular.module("myApp").value("gbToastr",toastr),angular.module("myApp").factory("gbNotifier",["gbToastr",function(a){return{notify:function(b){a.success(b)},error:function(b){a.error(b)}}}]);